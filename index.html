<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìŠ¤í”„ë¼ì´íŠ¸ ë©€í‹° ì˜ˆì œ</title>
  <style>
    body { margin:0; overflow:hidden; background:#1a1a1a;}
    canvas { display:block; }

    body, canvas, * {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}


    /* ìŠ¤íƒ¯ ë²„íŠ¼/íŒ¨ë„ CSS (ë³µë¶™) */
#statBtn {
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1200;
  /* ìŠ¤ë¥´ë¥µ íš¨ê³¼ */
  transition: transform 0.55s cubic-bezier(.5,2,.4,1), opacity 0.25s;
  background: rgba(34, 36, 40, 0.55);
  color: #fff;
  font-size: 16px;
  font-family: 'Pretendard', 'GmarketSans', Arial, sans-serif;
  font-weight: bold;
  padding: 4px 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  box-shadow: 0 2px 8px #1115;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 7px;
  opacity: 0;
  transform: translateY(-120%); /* â˜…â˜… ìµœì´ˆì— ì™„ì „íˆ ìœ„ì— ìˆ¨ê¸°ê¸° */
}

#statBtn.show {
  opacity: 1;
  transform: translateY(0);     /* â˜…â˜… ì•„ë˜ë¡œ ìŠ¤ë¥´ë¥µ ë‚˜íƒ€ë‚¨ */
}


#statBtn:hover {
  filter: brightness(1.08);
  background: #53ac48;
}
#statBtn:active {
  filter: brightness(0.92);
}
#statBtn .icon {
  font-size: 20px;
  margin-right: 2px;
}
#statBtn .statText {
  color: #fff;
  font-weight: bold;
  font-size: 1em;
  letter-spacing: 0.5px;
}

/* ìŠ¤íƒ¯íŒ¨ë„ ë””ìì¸ */
#statPanel {
  position: fixed;
  top: 14px; 
  left: 14px; 
  transform: none; /* ì¤‘ì•™ì •ë ¬ í•´ì œ */
  width: 340px; height: 420px;
  background: linear-gradient(145deg, #263c25 80%, #1c2a1b 100%);
  border-radius: 18px;
  box-shadow: 0 4px 20px #111a;
  border: 2.5px solid #2a4b22;
  padding: 16px 18px 16px 18px;
  z-index: 9999;
  display: flex; flex-direction: column;
  font-family: 'Pretendard', 'GmarketSans', Arial, sans-serif;
  cursor: grab;
  transition: box-shadow 0.15s, background 0.2s;
}

#statPanel.dragging {
  cursor: grabbing;
  box-shadow: 0 8px 36px #0a09;
  opacity: 0.97;
}
#statPanel.hide {
  display: none !important;
}
.statHeader {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 11px;
}
.statPoint {
  color: #3ff8e5;
  font-size: 1.28em;
  font-weight: bold;
  letter-spacing: 1px;
}
.btn {
  font-size: 1em; font-weight: bold;
  padding: 5px 16px; border-radius: 6px; margin-left: 8px; border: none; cursor: pointer;
  box-shadow: 0 2px 8px #1115;
  transition: filter 0.1s;
}
.btn.apply { background: #53ac48; color: #fff; }
.btn.close { background: #a3413d; color: #fff; }
.btn:active { filter: brightness(0.92); }
.statList {
  flex: 1; overflow-y: auto; background: #2228; border-radius: 10px; padding: 9px 6px 6px 6px;
  scrollbar-width: thin; scrollbar-color: #383 #181d16;
  user-select: none;
  cursor: grab;
}
.statList::-webkit-scrollbar { width: 7px; background: #222; }
.statList::-webkit-scrollbar-thumb { background: #2a4b22; border-radius: 8px; }
.statRow {
  display: flex; align-items: center; justify-content: space-between;
  margin: 0 0 8px 0; background: #191f16da;
  border-radius: 7px; padding: 11px 10px 7px 12px;
  box-shadow: 0 1px 7px #2223;
  font-size: 1.18em;
}
.statInfo { flex: 1 1 65%; }
.statName { font-weight: bold; color: #f8ea6b; font-size: 1.13em; }
.statDesc { font-size: 0.93em; color: #7cff66; margin-top: 2px;}
.statCtrl { display: flex; align-items: center; gap: 6px;}
.statCtrl button {
  width: 40px; height: 38px; font-size: 1.22em; font-weight: bold; border-radius: 7px;
  border: none; background: #406d3a; color: #fff; cursor: pointer;
  margin: 0 2px;
  box-shadow: 0 2px 8px #2235;
  transition: filter 0.12s, background 0.16s;
}
.statCtrl button.plus { background: #38a058; }
.statCtrl button.minus { background: #a03838; }
.statCtrl button:active { filter: brightness(0.88);}

.statValue {
  width: 26px; text-align: center; font-weight: bold; color: #fff;
  background: #1a1f1e; border-radius: 4px; margin: 0 2px; font-size: 1.09em;
  pointer-events: none;
}



/* ì±„íŒ…ì°½ ê°ì„± ìŠ¤íƒ€ì¼ */
#chatPanel {
  position: fixed;
  left: 0;           /* â† 38px â†’ 0 */
  bottom: 0;         /* â† 30px â†’ 0 */
  width: 340px;
  max-height: 160px;
  min-height: 160px;
  background: rgba(28,37,50,0.38);
  border-radius: 0 18px 16px 0;  /* ì¢Œí•˜ë‹¨ë§Œ ê°ì§€ê²Œ */
  box-shadow: 0 4px 28px #4be9ff7a, 0 0 0 2px #3ffffccc inset;
  border: 2px solid #1defffca;
  z-index: 1300;
  display: flex;
  flex-direction: column;
  backdrop-filter: blur(5px);
  transition: box-shadow .12s, max-height 0.18s;
}


#chatList {flex:1; overflow-y:auto; padding:13px 10px 8px 16px; font-size:15px; color:#f2faff;}
#chatForm {display:flex; align-items:center; border-top:2px solid #2af4ff4d;
  background:rgba(18,28,32,0.87); border-radius:0 0 14px 14px; padding:7px 10px 6px 12px;}
#chatInput {flex:1; background:none; border:none; outline:none; font-size:15px; color:#eafffa;
  padding:5px 8px; border-radius:8px;}
#chatInput::placeholder {color:#b2f2ff9a;}
#chatForm button {background:#27fff3; border:none; border-radius:9px; color:#1d2231; font-weight:bold;
  font-size:15px; padding:5px 12px; margin-left:8px; box-shadow:0 1px 6px #5efffd77; cursor:pointer;}
#chatForm button:hover {background:#b7ffff; color:#263d43;}

#rankPanel {
  position: fixed;
  right: 0;          /* â† 40px â†’ 0 */
  bottom: 0;         /* â† 34px â†’ 0 */
  width: 270px;
  min-height: 90px;
  max-height: 155px;
  background: linear-gradient(133deg, #232328cc 72%, #15161a99 100%);
  border-radius: 13px 0 0 0;     /* â† ìš°í•˜ë‹¨ë§Œ 0, ë‚˜ë¨¸ì§€ëŠ” 13px */
  border: 1.8px solid #24253a55;
  box-shadow: 0 5px 22px #0007, 0 0 0 2.5px #ffe08329 inset;
  color: #f3e7c5;
  padding: 10px 15px 9px 15px;
  font-family: 'Pretendard', 'SUIT', 'Arial', sans-serif;
  font-size: 15px;
  backdrop-filter: blur(12px);
  z-index: 1200;
  transition: box-shadow 0.18s;
}



.rankHeader {
  font-size: 1.11em; font-weight: 700;
  color: #ffe083;
  letter-spacing: 1.2px;
  margin-bottom: 7px; 
  padding-bottom: 5px;
  border-bottom: 1.5px solid #2c2a1f88;
  text-align: left;
  text-shadow: 0 2px 10px #836e3648, 0 0 2px #24201550;
}

.rankList {
  display: flex; flex-direction: column; gap: 7px;
}

.rankRow {
  display: flex; align-items: center;
  gap: 10px;
  background: linear-gradient(92deg, #232234ea 75%, #201b21c7 100%);
  border-radius: 8.5px;
  padding: 7px 12px 7px 13px;
  font-size: 1.01em;
  border-left: 5px solid #ffe08333;
  margin-bottom: 2px;
  box-shadow: 0 2.5px 9px #0003;
  transition: background 0.16s;
  filter: drop-shadow(0 2px 2px #0002);
}

.rankRow.top1 {
  background: linear-gradient(90deg, #3c3421 80%, #1c1610 100%);
  border-left: 5px solid #ffe159;
  color: #ffeab9;
  font-weight: 800;
}
.rankRow.top2 {
  background: linear-gradient(90deg, #263452 80%, #10161c 100%);
  border-left: 5px solid #b8c4ea;
  color: #e6eeff;
  font-weight: 700;
}
.rankRow.top3 {
  background: linear-gradient(90deg, #483b29 80%, #211911 100%);
  border-left: 5px solid #e1b579;
  color: #ffe6c6;
  font-weight: 700;
}

.rankRow .rankNum {
  width: 20px; 
  text-align: center;
  font-weight: 900;
  color: #f7ebc3;
  font-size: 1.13em;
}
.rankRow .name {
  flex: 2 1 120px;
  color: #fff8ee;
  font-weight: 700;
  text-shadow: 0 1px 6px #0006;
  letter-spacing: 0.5px;
  font-size: 1.03em;
}
.rankRow .level {
  color: #f6c95c;
  margin-left: 10px;
  font-weight: 700;
  font-size: 0.98em;
}
.rankRow .atk {
  color: #6edfff;
  margin-left: 8px;
  font-size: 0.97em;
}

#autoBtn {
  position: fixed;  /* í™”ë©´ ê¸°ì¤€ ê³ ì • */
  left: auto;
  right: 450px;   /* mp ì˜¤ë¸Œì—ì„œ ì‚´ì§ ì˜¤ë¥¸ìª½ */
  top: calc(100vh - 45px); /* ì— í”¼í†µê³¼ yì¢Œí‘œ ë§ì¶¤ (í•„ìš”ì‹œ ë¯¸ì„¸ì¡°ì •) */
  width: 36px; height: 36px;
  background: linear-gradient(145deg, #eee 60%, #aee4ff 100%);
  border-radius: 50%;
  border: 2.5px solid #3b83a7;
  box-shadow: 0 2px 8px #167fff50;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  z-index: 5000;
  transition: filter 0.13s;
  user-select: none;
}

#autoBtn.on {
  background: linear-gradient(135deg, #caffaa 70%, #38ed73 100%);
  border-color: #38ed73;
  filter: drop-shadow(0 0 7px #70ffb4cc);
}
#autoBtn span {
  font-size: 1.14em;
  color: #136d60;
  font-weight: bold;
  letter-spacing: -1px;
  pointer-events: none;
}
  
/* ì¸ë²¤í† ë¦¬ ë²„íŠ¼ ë””ìì¸ (ìŠ¤íƒ¯ë²„íŠ¼ê³¼ ê±°ì˜ ë™ì¼) */
#invBtn {
  position: fixed;
  top: 0;
  left: 146px; /* ìŠ¤íƒ¯ë²„íŠ¼ë³´ë‹¤ ì•½ê°„ ì˜¤ë¥¸ìª½ì— ë„ì›€ */
  z-index: 1200;
  transition: transform 0.55s cubic-bezier(.5,2,.4,1), opacity 0.25s;
  background: rgba(34, 36, 40, 0.55);
  color: #fff;
  font-size: 16px;
  font-family: 'Pretendard', 'GmarketSans', Arial, sans-serif;
  font-weight: bold;
  padding: 4px 18px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  box-shadow: 0 2px 8px #1115;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 7px;
  opacity: 1;
  transform: translateY(0);
}
#invBtn .icon { font-size: 21px; margin-right: 2px; }
#invBtn .invText { color: #fff; font-weight: bold; font-size: 1em; letter-spacing: 0.5px; }
#invBtn:hover { filter: brightness(1.08); background: #4b85cb; }
#invBtn:active { filter: brightness(0.92); }

/* ì¸ë²¤í† ë¦¬ íŒ¨ë„ (ìŠ¤íƒ¯íŒ¨ë„ ë””ìì¸ ì°¸ê³ ) */
#invPanel {
  position: fixed;
  top: 18px; left: 170px;
  width: 360px; height: 470px;
  background: linear-gradient(142deg, #27384a 80%, #182a3b 100%);
  border-radius: 18px;
  box-shadow: 0 4px 20px #111a;
  border: 2.5px solid #30507a;
  padding: 15px 15px 15px 15px;
  z-index: 9999;
  display: flex; flex-direction: column;
  font-family: 'Pretendard', 'GmarketSans', Arial, sans-serif;
  cursor: grab;
  transition: box-shadow 0.15s, background 0.2s;
}
#invPanel.dragging { cursor: grabbing; box-shadow: 0 8px 36px #003a; opacity: 0.98;}
#invPanel.hide { display: none !important; }
.invHeader {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.invGrid {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  grid-template-rows: repeat(6, 1fr);
  gap: 8px;
  background: #1b2533d7;
  border-radius: 13px;
  padding: 15px;
}
.invSlot {
  width: 46px; height: 46px;
  background: #253042;
  border-radius: 8px;
  border: 2.3px solid #45668a;
  box-shadow: 0 2px 8px #1115;
  display: flex; align-items: center; justify-content: center;
  font-size: 2em;
  color: #e6ebf7;
  transition: background 0.17s, border 0.13s;
  user-select: none;
}
.invSlot:hover { background: #375f9c; border-color: #80adf7; }

.invPageBar {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 14px;
  padding: 8px 0 2px 0;
  background: none;
  margin-top: 2px;
  margin-bottom: -6px;
}
.invPageBtn {
  background: #3a4d77;
  color: #ffecc7;
  font-size: 1.45em;
  font-weight: bold;
  border: none;
  border-radius: 9px;
  width: 38px; height: 38px;
  cursor: pointer;
  box-shadow: 0 2px 8px #1226;
  transition: background 0.18s, filter 0.13s;
  outline: none;
  user-select: none;
}
.invPageBtn:active {
  filter: brightness(0.9);
  background: #26509e;
}
.invPageNum {
  color: #ffecc7;
  font-weight: bold;
  font-size: 1.08em;
  min-width: 62px;
  text-align: center;
  letter-spacing: 1.2px;
  background: rgba(30,40,59,0.44);
  border-radius: 7px;
  padding: 4px 14px 2px 14px;
}











  </style>
</head>
<body>
   <audio id="bgm" src="ë°°ê²½ìŒì•….MP3" autoplay loop></audio>
   <audio id="skill2Sound" src="ìš°ë¢°ìƒ·ìŒ.ogg"></audio>
   <audio id="attackSound" src="ê¸°ë³¸ê³µê²©.ogg"></audio>
   <audio id="skill1Sound" src="ê°•ê²©.ogg"></audio>
   <audio id="hitSound" src="íƒ€ê²©ìŒ.ogg"></audio>
   <audio id="footstepSound" src="ë°œì†Œë¦¬.ogg"></audio>
   <audio id="deathSound" src="ì£½ëŠ”ìŒ.ogg"></audio>
   <audio id="levelupSound" src="ë ˆë²¨ì—….ogg"></audio>
   <audio id="butterflyDeathSound" src="ë‚˜ë¹„ì‚¬ë§ìŒ.ogg"></audio>
   <audio id="orbPickupSound" src="ì˜¤ë¸ŒìŠµë“.ogg"></audio>
   <audio id="applySound" src="ì ìš©.ogg"></audio>
   <audio id="statUpSound" src="ìŠ¤í…Ÿì°ê¸°.ogg"></audio>
   <audio id="statPanelOpenSound" src="ìŠ¤íƒ¯ë¶„ë°°.ogg"></audio>
   <audio id="windSound" src="ë°”ëŒì†Œë¦¬.wav"></audio>
   <audio id="criticalSound" src="í¬ë¦¬í‹°ì»¬.wav" preload="auto"></audio>
   <audio id="openBagSound" src="ê°€ë°©ì—´ê¸°.wav" preload="auto"></audio>













  <canvas id="game"></canvas>
  <div id="autoBtn" title="ê²½í—˜ì¹˜ì˜¤í† ">
  <span>Auto</span>
</div>
  <script src="/socket.io/socket.io.js"></script>


  <!-- ìŠ¤íƒ¯ë²„íŠ¼ -->
<button id="statBtn"><span class="icon">ğŸ“Š</span> <span class="statText">ìŠ¤íƒ¯ë¶„ë°°</span></button>
<!-- ìŠ¤íƒ¯ íŒ¨ë„ -->
<div id="statPanel">
  <div class="statHeader">
    <span class="statPoint">StatPoints: <span id="statPoints">0</span></span>
    <button class="btn apply">Apply</button>
    <button class="btn close">Close</button>
  </div>
  <div class="statList" id="statList"></div>
</div>


<!-- ì¸ë²¤í† ë¦¬ ë²„íŠ¼ -->
<button id="invBtn"><span class="icon">ğŸ’</span> <span class="invText">ì¸ë²¤í† ë¦¬</span></button>
<!-- ì¸ë²¤í† ë¦¬ íŒ¨ë„ -->
<div id="invPanel" class="hide">
  <div class="invHeader">
    <span style="font-size:1.13em;font-weight:bold;color:#ffeecc;">ì¸ë²¤í† ë¦¬</span>
    <button class="btn close">Close</button>
  </div>
  <div class="invGrid" id="invGrid"></div>

  <div class="invPageBar">
  <button class="invPageBtn" id="invPagePrev">&lt;</button>
  <span class="invPageNum" id="invPageNum">1 / 2</span>
  <button class="invPageBtn" id="invPageNext">&gt;</button>
</div>


</div>





<!-- ì±„íŒ… íŒ¨ë„ UI ì¶”ê°€ -->
<div id="chatPanel">
  <div id="chatList"></div>
  <form id="chatForm" autocomplete="off">
    <input id="chatInput" type="text" maxlength="60" placeholder="ì±„íŒ… ì…ë ¥(Enter)" />
    <button type="submit">ì „ì†¡</button>
  </form>
</div>

<!-- ìœ ì € ë­í‚¹ íŒ¨ë„ -->
<div id="rankPanel">
  <div class="rankHeader">
    <span class="crown gold">ğŸ‘‘</span>
    <span class="rankTitle">User Ranking</span>
  </div>
  <div class="rankList" id="rankList"></div>
</div>

<div id="onlinePanel"
  style="
    position:fixed;
    top:0; left:50%; transform:translateX(-50%);
    background:rgba(25,27,32,0.92);
    color:#ffe95d;
    font-weight:500;
    font-size:0.62em;
    padding:3px 16px 2px 16px;
    border-radius:4px;
    box-shadow:0 1px 6px #0007, 0 0 0 1.5px #ffe95d70 inset;
    border:1px solid #383838;
    z-index:9999;
    user-select:none;
    letter-spacing:0.5px;
    opacity:0.95;
    min-width:64px;
    text-align:center;
  ">
  í˜„ì¬ì ‘ì†ì: <span id="onlineNum">---ëª…</span>
</div>

<div id="autoWarning" style="
  display:none;
  position:fixed; 
  top:35px; left:50%; 
  transform:translateX(-50%);
  background: rgba(18,29,15,0.30); /* ê¸°ì¡´ 0.95 â†’ 0.30 (ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ë” íˆ¬ëª…) */
  color:#f44bfa;
  font-size:1.15em; 
  padding:9px 30px; 
  border-radius:16px;
  z-index:9999;
  box-shadow:0 3px 12px #0008;
  font-weight:bold;
  letter-spacing:2px;
">
  ì˜¤í† ëª¨ë“œì‹œ ë¶ˆê°€!
</div>


<div id="statApplyAlert" style="
  display:none;
  position:fixed;
  left:50%; top:19%;
  transform:translate(-50%, 0);
  background: rgba(18,29,15,0.30); /* ê¸°ì¡´ 0.95 â†’ 0.30 (ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ë” íˆ¬ëª…) */

  color:#bfff7f;
  font-weight:700;
  font-size:1.35em;
  padding:12px 34px 10px 34px;
  border-radius:18px;
  box-shadow:0 3px 14px #0d0 0.13;
  z-index:10000;
  letter-spacing:2px;
  text-align:center;
  user-select:none;
  opacity:0.98;
">ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.</div>

<div id="mapCoordPanel"
  style="
    position:fixed;
    top:0; right:0;
    background:rgba(25,27,32,0.92);
    color:#ffe95d;
    font-weight:500;
    font-size:0.62em;
    padding:3px 16px 2px 16px;
    border-radius:4px 0 0 4px;
    box-shadow:0 1px 6px #0007, 0 0 0 1.5px #ffe95d70 inset;
    border:1px solid #383838;
    z-index:9999;
    user-select:none;
    letter-spacing:0.5px;
    opacity:0.95;
    min-width:70px;
    text-align:center;
    pointer-events:none;
  ">
  ë§µì¢Œí‘œ <span id="mapCoordText">0:0</span>
</div>






  <script>
    document.getElementById('bgm').volume = 0.5; // 50% ë³¼ë¥¨
  document.getElementById('statBtn').classList.remove('show');
  const canvas = document.getElementById("game");
  const statPanel = document.getElementById('statPanel');
  let lastStatPoints = 0;
  let selectedSkill = 1;
 

  let autoOrb = false;
  const autoBtn = document.getElementById("autoBtn");
  autoBtn.onclick = function() {
  autoOrb = !autoOrb;
  autoBtn.classList.toggle("on", autoOrb);
  };

canvas.addEventListener("mousemove", function(e) {
  if (autoOrb) return; // ì˜¤í†  ONì´ë©´ ë§ˆìš°ìŠ¤ ì…ë ¥ ë¬´ì‹œ!
  mouseScreen.x = e.clientX;
  mouseScreen.y = e.clientY;
});


const ARROW_FRAME_COUNT = 4; // í”„ë ˆì„ ìˆ˜
const ARROW_FRAME_W = 60;    // í•œ í”„ë ˆì„ ë„ˆë¹„(px)
const ARROW_FRAME_H = 60;    // í•œ í”„ë ˆì„ ë†’ì´(px)







function drawButterflyHpBar(ctx, x, y, hp, maxHp, cam) {
  // HPë°” ìœ„ì¹˜: ë‚˜ë¹„ ë¨¸ë¦¬ ìœ„
  let bx = x - cam.x;
  let by = y - cam.y - BUTTERFLY_SIZE * 0.63; // ë¨¸ë¦¬ ìœ„ì—
  let width = 34, height = 6;
  let ratio = Math.max(0, Math.min(1, hp / maxHp));
  ctx.save();
  // í…Œë‘ë¦¬
  ctx.globalAlpha = 0.83;
  ctx.fillStyle = "#210";
  ctx.fillRect(bx - width / 2 - 1, by - height / 2 - 1, width + 2, height + 2);
  // HP ë¹¨ê°„ìƒ‰
  ctx.fillStyle = "#ff3333";
  ctx.fillRect(bx - width / 2, by - height / 2, width * ratio, height);
  // ë°”ê¹¥ì„ 
  ctx.strokeStyle = "#fff";
  ctx.lineWidth = 1.2;
  ctx.strokeRect(bx - width / 2 - 1, by - height / 2 - 1, width + 2, height + 2);
  ctx.restore();
}


    function expToNextLevel(level) {
  if (level <= 50) return 30 + (level-1)*8;
  else return 422 + Math.round(Math.pow(level-50, 2.2)*2.7);
}

function getPlayerStats(level) {
  return {
    hp: 50,    // ë ˆë²¨ì´ ì˜¬ë¼ê°€ë„ ê³ ì •!
    mp: 10,
    atk: 7,
    def: 0,
    range: 1,
    regen: 2
  };
}

       const socket = io();
    // === ì´ë¯¸ì§€ ë¡œë“œ ===
    const grassImg = new Image(); grassImg.src = "ë°”ë‹¥.png";
    const treeImg = new Image();  treeImg.src  = "ì°¸ë‚˜ë¬´.png";
    const scoutImg = new Image(); scoutImg.src = "ìŠ¤ì¹´ìš°íŠ¸.png";
    const arrowImg = new Image(); arrowImg.src = "ìŠ¤ì»¬ì§€í™”ì‚´.png";
    const dashboardImg = new Image();
    const yellowFlowerImg = new Image(); yellowFlowerImg.src = "ë…¸ë€ê½ƒ.png";
    const redFlowerImg    = new Image(); redFlowerImg.src = "ë¹¨ê°„ê½ƒ.png";
    const blueFlowerImg   = new Image(); blueFlowerImg.src = "íŒŒë€ê½ƒ.png";
    const whiteFlowerImg  = new Image(); whiteFlowerImg.src = "í•˜ì–€ê½ƒ.png";
    const BUTTERFLY_SIZE = 63;
const butterflyImg = new Image();
butterflyImg.src = "ë‚˜ë¹„.png";
let butterflies = [];

socket.on("butterflies", function(list) {
  butterflies = list;
});

    let playerAttackCooldownEnd = 0;
    let evadeParticles = []; // {x, y, life, maxLife}

    





dashboardImg.src = "ë°ì‹œë³´ë“œ.png"; // íŒŒì¼ëª…ì„ ì •í™•íˆ ë§ì¶°ì£¼ì„¸ìš”!

const skillIcon1 = new Image(); // ê°•ê²©
skillIcon1.src = "ê°•ê²©.png";
const skillIcon2 = new Image(); // ìš°ë¢°ìƒ·
skillIcon2.src = "ìš°ë¢°ìƒ·.png";




const ctx = canvas.getContext("2d");

let rightMouseDown = false;



canvas.addEventListener("mousedown", function(e) {
  if (e.button === 2) { // ì˜¤ë¥¸ìª½ ë§ˆìš°ìŠ¤
    rightMouseDown = true;
    e.preventDefault();

    // === ë°”ëŒì†Œë¦¬ ì¬ìƒ ===
    let wind = document.getElementById('windSound');
    if (wind) {
      wind.currentTime = 0; // ì—°íƒ€ì‹œ ì²˜ìŒë¶€í„°
      wind.play();
    }
  }
  // ì˜¤í† ëª¨ë“œì‹œ: ì˜¤ë¥¸ìª½ í´ë¦­ì€ ê²½ê³  ë„ìš°ì§€ ì•ŠìŒ!
  if (autoOrb) {
    if (e.button !== 2) showAutoWarning();
    return;
  }
});



canvas.addEventListener("mouseup", function(e) {
  if (e.button === 2) {
    rightMouseDown = false;
    e.preventDefault();
  }
});
canvas.addEventListener("contextmenu", e => e.preventDefault());



    // í”Œë ˆì´ì–´ ì˜¤ë¸Œì íŠ¸ì— ì¶”ê°€
    let glowTimer = 0;  // 0: ì—†ìŒ, >0: ë‚¨ì€ glow í”„ë ˆì„ ìˆ˜
    // ===== ìµœìƒë‹¨ì— íŒŒí‹°í´ ë°°ì—´ ì„ ì–¸ =====
let hitParticles = []; // [{x, y, vx, vy, life, maxLife} ...]
let damageParticles = []; // {x, y, value, life, maxLife}
let killMsg = null;   // {killer, victim, time}
let killMsgParticles = [];  // íŒŒí‹°í´ íš¨ê³¼ ë°°ì—´
let levelupParticles = []; // â† ìš”ê¸°!
let hp = 300, maxHp = 300, mp = 80, maxMp = 80;
let skillCooldowns = [0, 0]; // 0:ê°•ê²©, 1:ìš°ë¢°ìƒ· (íƒ€ì„ìŠ¤íƒ¬í”„)
// ê¸°ì¡´ let speed = 2; ë¶€ë¶„ì„ ì•„ë˜ë¡œ ë°”ê¿ˆ!
let speed = rightMouseDown ? 4 : 2; // 2ë°° ì´ì†
let yellowFlowers = [];
let redFlowers = [];
let blueFlowers = [];
let whiteFlowers = [];
let butterflyProjectiles = [];
let players = {};
let sparkles = [];



socket.on("butterflyProjectiles", arr => {
  butterflyProjectiles = arr;
});

socket.on("players", function(list) {
  players = list;
});

// ì „ì—­ì— ì¶”ê°€ (ë§¨ ìœ„ì—)
function makeArrowId() {
  // ì•„ì£¼ ê°„ë‹¨í•˜ê²Œ í˜„ì¬ ì‹œê°„+ëœë¤ê°’ ì¡°í•©
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 8);
}


function drawButterflyProjectiles(cam) {
  butterflyProjectiles.forEach(p => {
    ctx.save();
    ctx.globalAlpha = 0.7;
    ctx.beginPath();
    ctx.arc(p.x - cam.x, p.y - cam.y, 11, 0, Math.PI*2);
    ctx.fillStyle = "#ffe629"; // ë…¸ë€ìƒ‰ ì¹¨
    ctx.shadowColor = "#ffe700";
    ctx.shadowBlur = 9;
    ctx.fill();
    ctx.restore();
  });
}

function drawButterflyMove(ctx, x, y, dir, frame, cam) {
  // dir(0~3): 0ì•„ë˜ 1ì™¼ìª½ 2ì˜¤ë¥¸ìª½ 3ìœ„
  const sx = frame * BUTTERFLY_SIZE;
  const sy = dir * BUTTERFLY_SIZE;
  ctx.drawImage(
    butterflyImg,
    sx, sy, BUTTERFLY_SIZE, BUTTERFLY_SIZE,
    x - cam.x - BUTTERFLY_SIZE / 2,
    y - cam.y - BUTTERFLY_SIZE + 12,
    BUTTERFLY_SIZE, BUTTERFLY_SIZE
  );
}

  // === ê½ƒ ìœ„ì¹˜ ëœë¤ ìƒì„± ===
  socket.on("initTrees", (data) => {
  trees = data;
  yellowFlowers = getRandomFlowerPositions(100);
  redFlowers    = getRandomFlowerPositions(100);
  blueFlowers   = getRandomFlowerPositions(100);
  whiteFlowers  = getRandomFlowerPositions(100);
});

socket.on("onlineNum", function(n) {
  document.getElementById("onlineNum").textContent = n + "ëª…";
});


function drawButterflyAttack(ctx, x, y, dir, frame, cam) {
  // ì´ë™ê³¼ ë™ì¼
  drawButterflyMove(ctx, x, y, dir, frame, cam);
}
// ì‚¬ë§ ì• ë‹ˆ
function drawButterflyDead(ctx, x, y, deadFrameIdx, cam) {
  // deadFrameIdx: 0~2 (4,5,6í–‰, ì—´1)
  const sy = (4 + deadFrameIdx) * BUTTERFLY_SIZE;
  ctx.drawImage(
    butterflyImg,
    1 * BUTTERFLY_SIZE, sy, BUTTERFLY_SIZE, BUTTERFLY_SIZE,
    x - cam.x - BUTTERFLY_SIZE / 2, y - cam.y - BUTTERFLY_SIZE + 16, BUTTERFLY_SIZE, BUTTERFLY_SIZE
  );
}




function getRandomFlowerPositions(count) {
  const positions = [];
  const used = new Set();

  while (positions.length < count) {
    const fx = Math.random() * MAP_SIZE;
    const fy = Math.random() * MAP_SIZE;
    const key = Math.round(fx) + ',' + Math.round(fy);
    if (!used.has(key)) {
      used.add(key);
      positions.push({ x: fx, y: fy });
    }
  }
  return positions;
}

function drawEvadeParticles(cam) {
  evadeParticles.forEach(p => {
    let t = p.life / p.maxLife;         // 0~1
    let scale = 1.0 + 0.55 * t;         // ì ì  ì»¤ì§
    let alpha = 1.0 - t;                // ì ì  ì‚¬ë¼ì§
    let fontSize = 28 * scale;

    ctx.save();
    ctx.globalAlpha = 0.95 * alpha;
    ctx.font = `bold ${fontSize}px Pretendard, sans-serif`;
    ctx.fillStyle = "#39ff3a";           // ì„ ëª…í•œ ë…¹ìƒ‰
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 2.7 * scale;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    let px = p.x - cam.x;
    let py = p.y - cam.y;
    ctx.strokeText("íšŒí”¼", px, py);
    ctx.fillText("íšŒí”¼", px, py);
    ctx.restore();
  });
}






function showAutoWarning() {
  const el = document.getElementById('autoWarning');
  if (!el) return;
  el.style.display = 'block';
  clearTimeout(window._autoWarningTimer);
  window._autoWarningTimer = setTimeout(() => {
    el.style.display = 'none';
  }, 1400); // 1.4ì´ˆê°„ í‘œì‹œ
}


// ===== íŒŒí‹°í´ ì—…ë°ì´íŠ¸/ê·¸ë¦¬ê¸° í•¨ìˆ˜ ì¶”ê°€ =====
function updateHitParticles() {
  for (let i = hitParticles.length - 1; i >= 0; i--) {
    let p = hitParticles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.life++;
    if (p.life > p.maxLife) hitParticles.splice(i, 1);
  }
}
function drawHitParticles(cam) {
  hitParticles.forEach((p, i) => {
    let alpha = 1 - p.life / p.maxLife;
    ctx.save();
    ctx.globalAlpha = 1;  // ì¼ë‹¨ ì™„ì „ ë¶ˆíˆ¬ëª…ìœ¼ë¡œ
    ctx.beginPath();
    ctx.arc(p.x - cam.x, p.y - cam.y, 18 * alpha, 0, Math.PI * 2);  // ë” í¬ê²Œ!
    ctx.fillStyle = "#ff4444"; // ì™„ì „ ì§„í•˜ê²Œ
    ctx.fill();
    ctx.restore();
  });

  // pushëœ íŒŒí‹°í´ ê°œìˆ˜ ë³´ì´ê²Œ
  if (hitParticles.length > 0) {
    
  }
}



    function checkOrbPickup() {
  let updated = false;
  orbs.forEach((orb, i) => {
    const dx = player.x - orb.x, dy = player.y - orb.y;
    if (dx*dx + dy*dy < 360) { // 19px ì´ë‚´(ì¶©ëŒ)
      socket.emit("pickupOrb", orb.id);
      updated = true;
      // === ê²½í—˜ì¹˜ Glow íš¨ê³¼ ë°œë™!
      glowTimer = 18;  // 18í”„ë ˆì„ â‰ˆ 0.3ì´ˆ (60fps ê¸°ì¤€)
      let orbSound = document.getElementById('orbPickupSound');
      if (orbSound) {
        orbSound.currentTime = 0;
        orbSound.play();
      }

    }
  });
  if (updated) requestOrbs();
}

// ===== ë¬´ì‘ìœ„ ì˜ì–´ ë‹‰ë„¤ì„ ìƒì„± (ìµœìƒë‹¨ì—ì„œ, socket ìƒì„± ì´í›„!) =====
function randomId(len=8) {
  const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
  let id = "";
  for(let i=0;i<len;i++) id += chars[Math.floor(Math.random()*chars.length)];
  return id;
}
const nickname = randomId(8);
let myId = null;
socket.on("connect", () => {
  myId = socket.id;
  socket.emit("setname", nickname); // ì„œë²„ì— ë‹‰ë„¤ì„ ì „ë‹¬
});

// ===== ì±„íŒ… ì‹œìŠ¤í…œ =====
const chatList = document.getElementById('chatList');
const chatForm = document.getElementById('chatForm');
const chatInput = document.getElementById('chatInput');
chatForm.onsubmit = function(e){
  e.preventDefault();
  const msg = chatInput.value.trim();
  if(msg){
    socket.emit("chat", msg);
    chatInput.value = "";
  }
};
socket.on("chat", ({name, msg}) => {
  const div = document.createElement("div");
  div.innerHTML = `<b style="color:#70ffff;">${name}</b>: ${msg}`;
  chatList.appendChild(div);
  chatList.scrollTop = chatList.scrollHeight;
});


socket.on("killMsg", ({killer, victim}) => {
  
  killMsg = { killer, victim, time: Date.now() };

  // ì„íŒ©íŠ¸ íŒŒí‹°í´: í™”ë©´ ì¤‘ì•™ ìœ„ì—ì„œ í„°ì§€ê²Œ!
  for(let i=0; i<34; i++) {
    let angle = Math.random() * Math.PI * 2;
    let speed = 8 + Math.random()*3;
    killMsgParticles.push({
      x: canvas.width/2,
      y: 78,
      vx: Math.cos(angle)*speed,
      vy: Math.sin(angle)*speed,
      life: 0,
      maxLife: 22 + Math.random()*7
    });
  }
});

function updateKillMsgParticles() {
  for(let i=killMsgParticles.length-1; i>=0; i--) {
    let p = killMsgParticles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.18; // ì¤‘ë ¥ ëŠë‚Œ
    p.life++;
    if (p.life > p.maxLife) killMsgParticles.splice(i, 1);
  }
}
function drawKillMsgParticles() {
  killMsgParticles.forEach(p => {
    let alpha = 1 - p.life/p.maxLife;
    ctx.save();
    ctx.globalAlpha = alpha*0.75;
    ctx.beginPath();
    ctx.arc(p.x, p.y, 9*alpha, 0, Math.PI*2);
    ctx.fillStyle = `rgba(255,60,20,0.87)`;
    ctx.shadowColor = "#fff8";
    ctx.shadowBlur = 8*alpha;
    ctx.fill();
    ctx.restore();
  });
}



function drawKillMsg() {
  if (!killMsg) return;
  let elapsed = (Date.now() - killMsg.time) / 1000;
  if (elapsed > 2.5) { killMsg = null; return; }
  // ì„íŒ©íŠ¸ íš¨ê³¼: ì‚´ì§ ì»¤ì¡Œë‹¤ê°€ ì¤„ì–´ë“œëŠ” scale
  let t = Math.min(1, elapsed/0.25);
  let scale = 1.0; // â˜… 1ë°° ê³ ì •!
  ctx.save();
  ctx.globalAlpha = 1 - Math.max(0, (elapsed-2.0)/0.5); // ì ì  ì‚¬ë¼ì§
  ctx.font = `bold ${25*scale}px Pretendard, sans-serif`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.shadowColor = "#ff7322";
  ctx.shadowBlur = 14;

  // ë¬¸ì¥ ë¶„ë¦¬ ë Œë”ë§
  const textLeft = `${killMsg.killer} ë‹˜ì´ `;
  const textMid = `${killMsg.victim} ë‹˜ì„ `;
  const textRight = `ì²˜ì¹˜í–ˆìŠµë‹ˆë‹¤!`;

  // ì¤‘ì•™ ì¢Œí‘œ
  let x = canvas.width/2, y = 70;

  // í…ìŠ¤íŠ¸ ê¸¸ì´ ì¸¡ì •
  let widthLeft = ctx.measureText(textLeft).width;
  let widthMid = ctx.measureText(textMid).width;
  let widthAll = widthLeft + widthMid + ctx.measureText(textRight).width;

  let cursor = x - widthAll/2;

  // 1. killer (íŒŒë‘)
  ctx.fillStyle = "#339aff";
  ctx.fillText(killMsg.killer, cursor + ctx.measureText(killMsg.killer).width/2, y);
  cursor += ctx.measureText(killMsg.killer).width;

  // " ë‹˜ì´ " (í°ìƒ‰)
  ctx.fillStyle = "#fff";
  ctx.fillText(" ë‹˜ì´ ", cursor + ctx.measureText(" ë‹˜ì´ ").width/2, y);
  cursor += ctx.measureText(" ë‹˜ì´ ").width;

  // 2. victim (ë¹¨ê°•)
  ctx.fillStyle = "#ff2b2b";
  ctx.fillText(killMsg.victim, cursor + ctx.measureText(killMsg.victim).width/2, y);
  cursor += ctx.measureText(killMsg.victim).width;

  // " ë‹˜ì„ ì²˜ì¹˜í–ˆìŠµë‹ˆë‹¤!" (í°ìƒ‰)
  ctx.fillStyle = "#fff";
  ctx.fillText(" ë‹˜ì„ ì²˜ì¹˜í–ˆìŠµë‹ˆë‹¤!", cursor + ctx.measureText(" ë‹˜ì„ ì²˜ì¹˜í–ˆìŠµë‹ˆë‹¤!").width/2, y);

  ctx.restore();
}

function updateEvadeParticles() {
  for (let i = evadeParticles.length - 1; i >= 0; i--) {
    let p = evadeParticles[i];
    p.life++;
    if (p.life > p.maxLife) evadeParticles.splice(i, 1);
  }
}

socket.on("butterflyDeath", ({id}) => {
  let snd = document.getElementById('butterflyDeathSound');
  if (snd) { snd.currentTime = 0; snd.play(); }
});










// í´ë¼ ì†Œì¼“ ì´ë²¤íŠ¸
socket.on("hitEffect", ({ x, y, id, damage, arrowId, crit }) => {
  // í™”ì‚´ ì‚­ì œ
  if (arrowId !== undefined) {
    let idx = arrows.findIndex(a => a.id === arrowId);
    if (idx !== -1) arrows.splice(idx, 1);
  }

  // í”¼ê²©ìŒ
  let hitSound = document.getElementById('hitSound');
  if (hitSound) {
    hitSound.currentTime = 0;
    hitSound.play();
  }

  // ë‚˜ë¹„ ì‚¬ë§ìŒ ì¶”ê°€
  if (typeof id === "string" && id.startsWith("butterfly_") && damage > 0) {
    // ë‚˜ë¹„ id ì°¾ê¸°
    let butterfly = butterflies.find(b => "butterfly_" + b.id === id);
    if (butterfly && butterfly.hp <= 0) {
      let snd = document.getElementById('butterflyDeathSound');
      if (snd) { snd.currentTime = 0; snd.play(); }
    }
  }

  // íšŒí”¼ íŒŒí‹°í´!
  if (damage === 0) {
    evadeParticles.push({
      x: x,
      y: y - 52,      // ë¨¸ë¦¬ ìœ„ ìœ„ì¹˜
      life: 0,
      maxLife: 34     // 34í”„ë ˆì„ â‰ˆ 0.55ì´ˆ (ì ë‹¹íˆ ì¡°ì ˆ)
    });
    return;
  }

  // â­ï¸ í¬ë¦¬í‹°ì»¬ sparkles íŒŒí‹°í´ ìƒì„±
  if (crit) {

    let snd = document.getElementById('criticalSound');
  if (snd) {
    snd.currentTime = 0;
    snd.play();
  }

  damageParticles.push({
    x: x,
    y: y - 65, // ë¨¸ë¦¬ ìœ„
    value: damage,
    crit: true,
    life: 0,
    maxLife: 38, // í”„ë ˆì„(0.6ì´ˆì¯¤)
  });
}




  // í¬ë¦¬í‹°ì»¬ ì—¬ë¶€ì— ë”°ë¼ ë”± í•œ ë²ˆë§Œ!
  damageParticles.push({
    x,
    y: crit ? y - 65 : y - 48,
    value: damage,
    crit: !!crit,
    life: 0,
    maxLife: crit ? 48 : (32 + Math.random() * 7)
  });

  // íˆíŠ¸ íŒŒí‹°í´ (ìŠ¤íŒŒí¬)
  for (let i = 0; i < 14; i++) {
    let angle = Math.random() * Math.PI * 2;
    let speed = 4 + Math.random() * 2;
    hitParticles.push({
      x: x,
      y: y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      life: 0,
      maxLife: 12
    });
  }

  // í™”ì‚´ ì‚­ì œ (í˜¹ì‹œ ì¤‘ë³µì¼ ìˆ˜ ìˆìœ¼ë‹ˆ í•œ ë²ˆë§Œ ë”)
  if (arrowId !== undefined) {
    let idx = arrows.findIndex(a => a.id === arrowId);
    if (idx !== -1) arrows.splice(idx, 1);
  }

  while (hitParticles.length > 300) hitParticles.shift();
  while (damageParticles.length > 150) damageParticles.shift();
});


function drawDamageParticles(cam) {
  damageParticles.forEach(p => {
    let t = p.life / p.maxLife;
    // í¬ë¦¬í‹°ì»¬ì´ë©´ íŒ¡! ì»¤ì¡Œë‹¤ ì ì  ì‘ì•„ì§ (scale = 1.8 â†’ 1)
    let scale = p.crit ? 1.8 - 0.8 * t : 1.0 + 0.3 * (1 - t);
    let fontSize = (p.crit ? 28 : 18) * scale;
    let alpha = 1 - t;
    let px = p.x - cam.x;
    let py = p.y - cam.y - t * 16; // ì‚´ì§ ìœ„ë¡œ ë– ì˜¤ë¥´ë©° ì‚¬ë¼ì§

    ctx.save();
    ctx.globalAlpha = 0.97 * alpha;

    if (p.crit) {
      // 'CRITICAL' ì˜ì–´ ê¸€ì
      ctx.font = `bold ${fontSize * 0.7}px Pretendard, sans-serif`;
      ctx.fillStyle = "#ffd800";
      ctx.strokeStyle = "#ff5b00";
      ctx.lineWidth = 3.2 * scale;
      ctx.shadowColor = "#fff7b1";
      ctx.shadowBlur = 13 * scale;
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.strokeText("CRITICAL", px, py - 19);
      ctx.fillText("CRITICAL", px, py - 19);

      // ë°ë¯¸ì§€ ìˆ«ì (ë” í¬ê³  ì§„í•˜ê²Œ)
      ctx.font = `bold ${fontSize}px Pretendard, sans-serif`;
      ctx.fillStyle = "#fff24a";
      ctx.strokeStyle = "#ea9900";
      ctx.lineWidth = 4 * scale;
      ctx.shadowColor = "#ffe600";
      ctx.shadowBlur = 15 * scale;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.strokeText(p.value, px, py);
      ctx.fillText(p.value, px, py);
    } else {
      // ì¼ë°˜ ìˆ«ì
      ctx.font = `bold ${fontSize}px Pretendard, sans-serif`;
      ctx.fillStyle = "#ff2424";
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2.5 * scale;
      ctx.shadowColor = "#ffb9b9";
      ctx.shadowBlur = 6 * scale;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.strokeText(p.value, px, py);
      ctx.fillText(p.value, px, py);
    }
    ctx.restore();
  });
}





function updateDamageParticles() {
  for (let i = damageParticles.length - 1; i >= 0; i--) {
    let p = damageParticles[i];
    p.y -= 1.7;       // ìœ„ë¡œ ìŠ¤ë¥´ë¥µ ì˜¬ë¼ê°
    p.life++;
    if (p.life > p.maxLife) damageParticles.splice(i, 1);
  }
}









function getSkillCooldownRemaining(skillIndex) {
  const now = Date.now();
  const end = skillCooldowns[skillIndex] || 0;
  return Math.max(0, end - now);
}








    function isZoomed() {
  return Math.round(window.devicePixelRatio * 100) !== 100;
}

window.addEventListener('resize', () => {
  if (isZoomed()) {
    alert('ë¸Œë¼ìš°ì € í™•ëŒ€/ì¶•ì†Œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤! 100%ë¡œ ë§ì¶°ì£¼ì„¸ìš”.');
  }
});

// [1] ìŠ¤íƒ¯ ë°ì´í„°
const statListData = [
  { id: "hp", name: "ì²´ë ¥", desc: "1í¬ì¸íŠ¸ë‹¹ ìµœëŒ€ì²´ë ¥ +10 ì¦ê°€" },
  { id: "mp", name: "ë§ˆë‚˜", desc: "1í¬ì¸íŠ¸ë‹¹ ìµœëŒ€ë§ˆë‚˜ +5 ì¦ê°€" },
  { id: "str", name: "í˜", desc: "1í¬ì¸íŠ¸ë‹¹ ê³µê²©ë ¥ +3 ì¦ê°€" },
  { id: "int", name: "ì§€ëŠ¥", desc: "1í¬ì¸íŠ¸ë‹¹ íšŒë³µ -0.1ì´ˆ ì¦ê°€" },
  { id: "vit", name: "ì¸ë‚´", desc: "1í¬ì¸íŠ¸ë‹¹ ë°©ì–´ë ¥ +1 ì¦ê°€" },
  { id: "agi", name: "ë¯¼ì²©", desc: "1í¬ì¸íŠ¸ë‹¹ íšŒí”¼ìœ¨ +0.1% ì¦ê°€" },
  { id: "luk", name: "ìš´", desc: "1í¬ì¸íŠ¸ë‹¹ í¬ë¦¬í™•ë¥  +0.4% ì¦ê°€" },
  { id: "acc", name: "ëª…ì¤‘", desc: "1í¬ì¸íŠ¸ë‹¹ ëª…ì¤‘ë¥  +0.25% ì¦ê°€" },
  { id: "aspd", name: "ê³µì†", desc: "1í¬ì¸íŠ¸ë‹¹ ê³µê²©ì†ë„ +0.1% ì¦ê°€" },
  { id: "mspd", name: "ì´ì†", desc: "1í¬ì¸íŠ¸ë‹¹ ì´ë™ì†ë„ +0.1 ì¦ê°€" }
];
let statPoints = 0;
let statLevels = {};
let tempStatLevels = {};
let tempStatPoints = 0;
statListData.forEach(stat => {
  statLevels[stat.id] = 0;
});


statListData.forEach(stat => statLevels[stat.id] = 0);

// [2] ìŠ¤íƒ¯ í–‰ ë Œë”ë§ í•¨ìˆ˜
function renderStatRows() {
  const statList = document.getElementById('statList');
  statList.innerHTML = '';
  statListData.forEach(stat => {
    const row = document.createElement('div');
    row.className = 'statRow';

        let disabled = '';
    // ì—¬ê¸°ì„œ ëª…ì¤‘(acc)ì´ 100 ì´ìƒì´ë©´ +ë²„íŠ¼ ë¹„í™œì„±í™”
    if (
  (stat.id === "luk" && (tempStatLevels["luk"] || 0) >= 100) ||
  (stat.id === "int" && (tempStatLevels["int"] || 0) >= 60) ||
  (stat.id === "mspd" && (tempStatLevels["mspd"] || 0) >= 100) ||
  (stat.id === "aspd" && (tempStatLevels["aspd"] || 0) >= 100)
) {
  disabled = 'disabled';
}



// ì œí•œ í‘œì‹œ ê²°ì •
let limitText = "";
if (stat.id === "int") limitText = '<span style="color:#ff70ec;font-size:0.80em;margin-left:7px;">(Lv60ì œí•œ)</span>';
if (["luk", "aspd", "mspd"].includes(stat.id)) limitText = '<span style="color:#ff70ec;font-size:0.80em;margin-left:7px;">(Lv100ì œí•œ)</span>';

row.innerHTML = `
  <div class="statInfo">
    <div class="statName">
      ${stat.name}
      <span class="statValue">Lv.${tempStatLevels[stat.id] || 0}</span>
      ${limitText}
    </div>
    <div class="statDesc">${stat.desc}</div>
  </div>
  <div class="statCtrl" style="gap:8px;">
    <button class="plus" data-id="${stat.id}" ${disabled}>+</button>
  </div>
`;


    statList.appendChild(row);
  });
  document.getElementById('statPoints').textContent = tempStatPoints;
}




renderStatRows();

// [3] +, - ë²„íŠ¼ ë™ì‘
document.getElementById('statList').addEventListener('click', function(e){
    e.preventDefault(); // â† ì´ê±° í•œ ì¤„ë§Œ ì¶”ê°€!
  const id = e.target.dataset.id;
  if(e.target.classList.contains('plus') && tempStatPoints > 0) {
    if(id === "int" && tempStatLevels["int"] >= 60) return;
    if(id === "mspd" && tempStatLevels["mspd"] >= 100) return;
    tempStatLevels[id]++; tempStatPoints--;

    // === ì—¬ê¸° ìŒ ì¬ìƒ ì¶”ê°€! ===
    let snd = document.getElementById('statUpSound');
    if (snd) { snd.currentTime = 0; snd.play(); }


  }
  if(e.target.classList.contains('minus') && tempStatLevels[id] > 0) {
  tempStatLevels[id]--; tempStatPoints++;
}

  renderStatRows();
});

statPanel.querySelector('.btn.apply').onclick = function() {
  socket.emit("setStats", tempStatLevels);
  statPanel.classList.add('hide');
  // ====== ì•„ë˜ ì½”ë“œ ì¶”ê°€! ======
  // ì„ì‹œê°’/ì„ì‹œí¬ì¸íŠ¸ë¥¼ statLevels/statPointsë¡œ ê°•ì œ ë™ê¸°í™”
  tempStatLevels = { ...statLevels };
  tempStatPoints = statPoints;
  renderStatRows();
  
  // === ì ìš© ì•Œë¦¼ ê°•ì œ í‘œì‹œ ===
  const alertDiv = document.getElementById('statApplyAlert');
   // íš¨ê³¼ìŒ ì¶”ê°€!
  let snd = document.getElementById('applySound');
  if (snd) { snd.currentTime = 0; snd.play(); }

  if (alertDiv) {
    // ë¨¼ì € ê¸°ì¡´ì— ë– ìˆë˜ê±° ìˆ¨ê¹€(í´ë¦­ ì—¬ëŸ¬ë²ˆ ëŒ€ì‘)
    alertDiv.style.transition = '';
    alertDiv.style.display = 'none';
    alertDiv.offsetHeight; // ê°•ì œ ë¦¬í”Œë¡œìš°ë¡œ ì´ˆê¸°í™”
    alertDiv.style.display = 'block';
    alertDiv.style.opacity = '0.98';
    setTimeout(() => {
      alertDiv.style.transition = 'opacity 0.44s';
      alertDiv.style.opacity = '0';
      setTimeout(() => {
        alertDiv.style.display = 'none';
        alertDiv.style.transition = '';
      }, 450);
    }, 1500);
  }
   // ğŸ‘‡ğŸ‘‡ ì´ í•œ ì¤„! ğŸ‘‡ğŸ‘‡
  document.getElementById('statBtn').classList.remove('show');
};





document.getElementById('statBtn').onclick = function() {
  let snd = document.getElementById('statPanelOpenSound');
  if (snd) { snd.currentTime = 0; snd.play(); }

  tempStatLevels = { ...statLevels };
  tempStatPoints = statPoints;
  renderStatRows();
  statPanel.classList.remove('hide');
  // í•­ìƒ ì¢Œìƒë‹¨ ëª¨ì„œë¦¬ ê³ ì •!
  panelX = 0;
  panelY = 0;
  statPanel.style.left = `${panelX}px`;
  statPanel.style.top = `${panelY}px`;
  statPanel.style.transform = 'none';
};







// [5] ë‹«ê¸° ë²„íŠ¼

statPanel.classList.add('hide');
const closeBtn = statPanel.querySelector('.btn.close');
closeBtn.addEventListener('click', function(){
  statPanel.classList.add('hide');
  // â†“â†“â†“ íŒ¨ë„ ë‹«ì„ ë•Œë„ ì„ì‹œê°’ ì´ˆê¸°í™”!
  tempStatPoints = statPoints;
  tempStatLevels = { ...statLevels };
  renderStatRows();
});



// [6] íŒ¨ë„ ë“œë˜ê·¸ ì´ë™
let offsetX = 0, offsetY = 0, isDragging = false;
let panelX = 14; // ì¢Œì¸¡ ìƒë‹¨ì— ë”± ë¶™ê²Œ
let panelY = 14;
statPanel.style.left = `${panelX}px`;
statPanel.style.top = `${panelY}px`;
statPanel.style.transform = 'none';

function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }
statPanel.addEventListener('mousedown', function(e) {
  if (e.button !== 0) return;
  isDragging = true;
  offsetX = e.clientX - statPanel.offsetLeft;
  offsetY = e.clientY - statPanel.offsetTop;
  statPanel.classList.add('dragging');
  e.preventDefault();
});
window.addEventListener('mousemove', function(e) {
  if (!isDragging) return;
  let nx = e.clientX - offsetX;
  let ny = e.clientY - offsetY;
  const minX = 0;
  const minY = 0;
  const maxX = window.innerWidth - statPanel.offsetWidth;
  const maxY = window.innerHeight - statPanel.offsetHeight;
  nx = clamp(nx, minX, maxX);
  ny = clamp(ny, minY, maxY);
  panelX = nx;
  panelY = ny;
  statPanel.style.left = `${panelX}px`;
  statPanel.style.top = `${panelY}px`;
});
window.addEventListener('mouseup', function(e) {
  if (isDragging) {
    isDragging = false;
    statPanel.classList.remove('dragging');
  }
});
window.addEventListener('resize', function(){
  const maxX = window.innerWidth - statPanel.offsetWidth;
  const maxY = window.innerHeight - statPanel.offsetHeight;
  panelX = clamp(panelX, 0, maxX);
  panelY = clamp(panelY, 0, maxY);
  statPanel.style.left = `${panelX}px`;
  statPanel.style.top = `${panelY}px`;
});


// 1~70ë ˆë²¨ê¹Œì§€ ìƒ˜í”Œ ì¶œë ¥
for (let lv=1; lv<=70; lv++) {
  
}





// 1, 10, 50, 51, 70ë ˆë²¨ ì˜ˆì‹œ
[1, 10, 50, 51, 70].forEach(lv => {
  
});



    

    const TILE_SIZE = 32;
    const MAP_SIZE = 50000;
    const SPRITE_SIZE = 200;
    const FRAMES = 8;
    let arrows = []; // {x, y, vx, vy, frame, anim, dir}
    let targetPos = null; // {x, y}
    let mouseWorld = null;
    let mouseScreen = { x: window.innerWidth / 2, y: window.innerHeight / 2 }; // ê¸°ë³¸ê°’: í™”ë©´ ì¤‘ì•™
    let orbs = [];
  

     // ì„œë²„ì—ì„œ ë‚´ ìŠ¤íƒ¯/ê²½í—˜ì¹˜/HP/MP ë“± ë³€ê²½ëœ ì •ë³´ ìˆ˜ì‹ !
// ì˜ˆì‹œ: ì„œë²„ì—ì„œ playerStats ë°›ëŠ” ê³³ ë“±
socket.on("playerStats", function(data) {
  statPoints = data.statPoints ?? 0;
  statLevels = { ...data.statLevels };

  // íŒ¨ë„ ë‹«í˜€ ìˆì„ ë•Œë§Œ ì„ì‹œê°’ ë™ê¸°í™”
  if (statPanel.classList.contains('hide')) {
    tempStatPoints = statPoints;
    tempStatLevels = { ...statLevels };
    renderStatRows();
    document.getElementById('statPoints').textContent = statPoints;
  }

  // ğŸ‘‡ ë ™ì—…(=statPoints ì¦ê°€) ì‹œ ìŠ¤íƒ¯ë²„íŠ¼ show!
  if (statPoints > lastStatPoints) {
    showStatButton();

      let levelupSound = document.getElementById('levelupSound');
    if (levelupSound) {
      levelupSound.currentTime = 0;
      levelupSound.play();
    }

    levelupParticles.push({
  id: myId,   // ë‚´ í”Œë ˆì´ì–´ id!
  life: 0,
  maxLife: 48 // 0.8ì´ˆ (60fps)
});



  }
  lastStatPoints = statPoints;
});

function updateLevelupParticles() {
  for (let i = levelupParticles.length - 1; i >= 0; i--) {
    let p = levelupParticles[i];
    p.life++;
    if (p.life > p.maxLife) levelupParticles.splice(i, 1);
  }
}


/// ==== ì¸ë²¤í† ë¦¬ ë²„íŠ¼/íŒ¨ë„ ====
const invBtn = document.getElementById('invBtn');
const invPanel = document.getElementById('invPanel');
const invGrid = document.getElementById('invGrid');
const invPageNum = document.getElementById('invPageNum');
const invPagePrev = document.getElementById('invPagePrev');
const invPageNext = document.getElementById('invPageNext');

// ==== ì¸ë²¤í† ë¦¬ í˜ì´ì§• ====
let invPage = 0; // 0ë¶€í„° ì‹œì‘ (1í˜ì´ì§€)
let invPageMax = 2; // ì´ 2í˜ì´ì§€ (ì˜ˆì‹œ: 2ë¡œ ì„¤ì •, ë” ëŠ˜ë¦´ ìˆ˜ë„ ìˆìŒ)
let inventory = Array.from({length:30*invPageMax}, (_,i)=>({id:null, icon:""}));
// ìŠ¬ë¡¯ ì˜ˆì‹œ ì•„ì´ì½˜ (ì›í•˜ë©´ ë°”ê¿”ë„ ë¨)
const demoIcons = ["ğŸ—¡ï¸","ğŸ›¡ï¸","ğŸ","ğŸ”®","ğŸ’","ğŸ¹","ğŸ¥¾","ğŸª™"];
inventory[0] = {id:1, icon:demoIcons[0]};
inventory[1] = {id:2, icon:demoIcons[3]};
inventory[37] = {id:101, icon:demoIcons[6]}; // 2í˜ì´ì§€ 8ë²ˆì§¸ ì¹¸ì— ì•„ì´í…œ

// í˜ì´ì§€ ë Œë”
function renderInventory() {
  invGrid.innerHTML = "";
  let start = invPage * 30;
  let end = start + 30;
  for(let i=start; i<end; i++) {
    const slot = document.createElement('div');
    slot.className = 'invSlot';
    slot.innerHTML = inventory[i]?.icon || "";
    invGrid.appendChild(slot);
  }
  invPageNum.textContent = (invPage+1) + " / " + invPageMax;
  invPagePrev.disabled = (invPage === 0);
  invPageNext.disabled = (invPage === invPageMax-1);
}
renderInventory();

// ë²„íŠ¼ í´ë¦­
invPagePrev.onclick = () => { if(invPage>0){invPage--;renderInventory();}};
invPageNext.onclick = () => { if(invPage<invPageMax-1){invPage++;renderInventory();}};

// ì—´ê³ /ë‹«ê¸° ë²„íŠ¼
invBtn.onclick = () => {
  invPanel.classList.toggle("hide");
  // ê°€ë°© ì—´ê¸° íš¨ê³¼ìŒ ì¬ìƒ
  if (!invPanel.classList.contains("hide")) {
    const snd = document.getElementById("openBagSound");
    if (snd) { snd.currentTime = 0; snd.play(); }
  }
};

invPanel.querySelector('.btn.close').onclick = () => invPanel.classList.add("hide");

// ==== ì¸ë²¤í† ë¦¬ íŒ¨ë„ ë“œë˜ê·¸ & í™”ë©´ ë°– ë°©ì§€ ====
let invDrag = {dragging:false, offsetX:0, offsetY:0};
invPanel.addEventListener("mousedown", e=>{
  if(e.target.classList.contains('btn')) return;
  invDrag.dragging = true;
  invPanel.classList.add("dragging");
  invDrag.offsetX = e.clientX - invPanel.offsetLeft;
  invDrag.offsetY = e.clientY - invPanel.offsetTop;
});
document.addEventListener("mousemove", e=>{
  if(!invDrag.dragging) return;
  let nx = e.clientX - invDrag.offsetX;
  let ny = e.clientY - invDrag.offsetY;
  // í™”ë©´ ê²½ê³„ ì²´í¬
  let maxX = window.innerWidth - invPanel.offsetWidth;
  let maxY = window.innerHeight - invPanel.offsetHeight;
  nx = Math.max(0, Math.min(nx, maxX));
  ny = Math.max(0, Math.min(ny, maxY));
  invPanel.style.left = nx + "px";
  invPanel.style.top = ny + "px";
});
document.addEventListener("mouseup", ()=>{ invDrag.dragging=false; invPanel.classList.remove("dragging"); });









function drawLevelupParticles(cam) {
  levelupParticles.forEach(p => {
    // í”Œë ˆì´ì–´ ì˜¤ë¸Œì íŠ¸ë¥¼ í•­ìƒ ìµœì‹  ì¢Œí‘œë¡œ ì°¸ì¡°!
    let ply = allPlayers[p.id];
    if (!ply) return;
    // ë¨¸ë¦¬ ìœ„ì— ë„ìš°ê¸°
    let px = ply.x - cam.x;
    let py = ply.y - cam.y - 84; // ìºë¦­í„° ë¨¸ë¦¬ ìœ„ ì¢€ ë” ìœ„ë¡œ
    let t = p.life / p.maxLife;
    let alpha = 1 - t;
    let scale = 1.13 + 0.6 * t;
    ctx.save();
    ctx.globalAlpha = 0.86 * alpha;
    ctx.font = `bold ${34*scale}px Pretendard, Arial, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.shadowColor = "#fffcc2";
    ctx.shadowBlur = 16;
    ctx.fillStyle = "#ffe85d";
    ctx.fillText("ë ˆë²¨ì—…!", px, py);
    ctx.restore();
  });
}




function showStatButton() {
  const btn = document.getElementById('statBtn');
  btn.classList.add('show');
}



closeBtn.addEventListener('click', function(){
  statPanel.classList.add('hide');
  document.getElementById('statBtn').classList.remove('show');
  // ...ê¸°ì¡´ ì½”ë“œ
});




socket.on("attackResult", function(data) {
   let attackSound = document.getElementById('attackSound');
  if (attackSound) {
    attackSound.currentTime = 0;
    attackSound.play();
  }
  // ëª¨ë“  ê³µê²©ì— ëŒ€í•´ í™”ì‚´ì„ ìƒì„±!
  let startX = data.x;
  let startY = data.y + 2;
  let dx = data.mouseX - startX;
  let dy = data.mouseY - startY;
  let dist = Math.sqrt(dx*dx + dy*dy);
  let speed = 22;
  let vx = dx / dist * speed;
  let vy = dy / dist * speed;
  let angle = Math.atan2(dy, dx);

   let maxDist = 700;
  if (data.skill === 1 || data.skill === 2) maxDist = 4200;
  arrows.push({
    x: startX,
    y: startY,
    vx: vx,
    vy: vy,
    frame: 0,
    anim: 0,
    angle: angle,
    hitFade: false,  // í”¼ê²© ì‹œ trueë¡œ ë³€ê²½
    alpha: 0.92,      // ê¸°ë³¸ íˆ¬ëª…ë„
    distance: 0,
    maxDistance: maxDist,   // â˜… ì„œë²„ì™€ ë˜‘ê°™ì´!
    shooterId: data.id,
    id: makeArrowId()
  });




  




  if (data.id === myId) {
    player.state = "attack";
    player.frame = 0;
    player.animTimer = 0;
  }
});




// ì„œë²„ì—ì„œ êµ¬ìŠ¬ ë°›ì•„ì˜¤ê¸°
socket.on("orbs", data => {
  orbs = data;
});

function requestOrbs() {
  socket.emit("requestOrbs", { x: player.x, y: player.y });
}

function drawOrbs(cam) {
  orbs.forEach(orb => {
    // í™”ë©´ì— ë³´ì´ëŠ” ê²ƒë§Œ!
    let sx = orb.x - cam.x, sy = orb.y - cam.y;
    if (
      sx < -30 || sx > canvas.width+30 ||
      sy < -30 || sy > canvas.height+30
    ) return;

    // êµ¬ìŠ¬(ë…¸ë€ ì›+ê´‘ì±„)
    ctx.save();
    ctx.beginPath();
    ctx.arc(sx, sy, 10, 0, Math.PI*2);
    ctx.fillStyle = "#ffe76a";
    ctx.shadowColor = "#ffe26d";
    ctx.shadowBlur = 15;
    ctx.globalAlpha = 0.92;
    ctx.fill();
    ctx.shadowBlur = 0;
    ctx.globalAlpha = 1.0;

    // í…Œë‘ë¦¬/ë°˜ì§
    ctx.beginPath();
    ctx.arc(sx, sy, 13, 0, Math.PI*2);
    ctx.strokeStyle = "#fff8";
    ctx.lineWidth = 2.2;
    ctx.stroke();

    ctx.font = "bold 12px sans-serif";
    ctx.fillStyle = "#845700";
    ctx.textAlign = "center";
    ctx.fillText("EXP", sx, sy+4);

    ctx.restore();
  });
}



function updateOrbs() {
  orbs.forEach(orb => {
    // í”Œë ˆì´ì–´ì™€ ê±°ë¦¬ ê³„ì‚°
    const dx = player.x - orb.x;
    const dy = player.y - orb.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    // ë¹¨ë ¤ë“œëŠ” ê±°ë¦¬(120í”½ì…€ ì´í•˜)
    if (dist < 120) {
      // í”Œë ˆì´ì–´ ë°©í–¥ìœ¼ë¡œ ì†ë„ ë¶€ì—¬ (ë³´í†µ 6~10í”½ì…€/frame)
      const pullSpeed = 8 + 10*(1 - dist/120); // ê°€ê¹Œìš¸ìˆ˜ë¡ ë¹¨ë¼ì§
      orb.x += dx / dist * pullSpeed;
      orb.y += dy / dist * pullSpeed;
    }
  });
}


closeBtn.addEventListener('click', function(){
  statPanel.classList.add('hide');
  // ìŠ¤íƒ¯ë²„íŠ¼ ìˆ¨ê¸°ê¸°
  document.getElementById('statBtn').classList.remove('show');
});


socket.on("playerStats", function(stats) {
  Object.assign(player, stats);
  renderStatRows();
  
});

socket.on("players", function(list) {
  players = list;
  // ë‚´ id(player)ë§Œì€ ë®ì–´ì“°ì§€ ì•Šê¸° (ë˜ëŠ” ë°˜ì˜ ì•ˆ í•¨)
});





function drawStatusBars() {



}






    // ë‚´ í”Œë ˆì´ì–´ ìƒíƒœ
    let player = {
      x: MAP_SIZE / 2, y: MAP_SIZE / 2,
      dir: "right", state: "idle", frame: 0, animTimer: 0,
      hp: 50, maxHp: 50,
      mp: 10, maxMp: 10,
      exp: 0, maxExp: 30
    };
    

    // ì„œë²„ì—ì„œ ë°›ëŠ” ì˜¤ë¸Œì íŠ¸
    let trees = [];
    let allPlayers = {}; // { id: {x, y, dir, state, frame} }

    // ì†Œì¼“ ì—°ê²°
   
    socket.on("connect", () => { myId = socket.id; });
    socket.on("initTrees", (data) => { trees = data; });


    socket.on("players", (data) => {
  allPlayers = data;
  // ë‚´ player ì˜¤ë¸Œì íŠ¸ë„ ì„œë²„ê°’ìœ¼ë¡œ ë™ê¸°í™”
  // ë‚´ player ì˜¤ë¸Œì íŠ¸ë„ ì„œë²„ê°’ìœ¼ë¡œ ë™ê¸°í™”
if (allPlayers[myId]) {
  // ì£½ëŠ”ìŒ: ê¸°ì¡´ì— ì£½ì€ ìƒíƒœê°€ ì•„ë‹ˆì—ˆê³ , ì´ì œ ì£½ì—ˆìœ¼ë©´ ì†Œë¦¬
  if (player.state !== "dead" && allPlayers[myId].state === "dead") {
    let deathSound = document.getElementById("deathSound");
    if (deathSound) {
      deathSound.currentTime = 0;
      deathSound.play();
    }
  }
  Object.assign(player, allPlayers[myId]);
}



  renderRanking(); // ë­í‚¹ ì‹¤ì‹œê°„ ê°±ì‹ !

});


    // ìº”ë²„ìŠ¤ ë¦¬ì‚¬ì´ì¦ˆ
    function resizeCanvas() {
  // ë””ë°”ì´ìŠ¤ í”½ì…€ë¹„ìœ¨ (ex. ë ˆí‹°ë‚˜ë©´ 2, ë³´í†µ 1)
  const dpr = window.devicePixelRatio || 1;
  canvas.width = window.innerWidth * dpr;
  canvas.height = window.innerHeight * dpr;
  canvas.style.width = window.innerWidth + "px";
  canvas.style.height = window.innerHeight + "px";
  ctx.setTransform(1, 0, 0, 1, 0, 0); // ë¦¬ì…‹
  ctx.scale(dpr, dpr); // ëª¨ë“  ê·¸ë¦¬ê¸° 1:1 ë§¤ì¹­!
}

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // í‚¤ ì…ë ¥
    const keys = {};
    window.addEventListener("keydown", e => { keys[e.key] = true; });
    window.addEventListener("keyup", e => { keys[e.key] = false; });


// â˜… ìºë¦­í„° dir ê³„ì‚° í•¨ìˆ˜ (ì¢Œ/ìš°)
function getDirectionFromMouse(playerX, playerY, mouseX, mouseY, prevDir = "right") {
  const dx = mouseX - playerX, dy = mouseY - playerY;
  if (Math.abs(dx) > Math.abs(dy)) return dx > 0 ? "right" : "left";
  return prevDir;
}




// ì¼ë°˜ê³µê²©
canvas.addEventListener("mousedown", function(e) {
  if (e.button === 0 && !autoOrb) { // 0=ì™¼ìª½ë²„íŠ¼
    const now = Date.now();
    if (now < playerAttackCooldownEnd) return; // ì¿¨íƒ€ì„ ì¤‘ì´ë©´ ë¬´ì‹œ

    // ì„œë²„ë¡œ ê³µê²© ìš”ì²­
    socket.emit("attack", {
      dir: player.dir,
      mouseX: mouseWorld?.x || player.x + 1,
      mouseY: mouseWorld?.y || player.y
    });
    // ì„œë²„ì™€ ë™ì¼í•œ ê³µì‹ (aspd ì ìš©)
    playerAttackCooldownEnd = now + 1000 / (statLevels.aspd ? (1 + statLevels.aspd * 0.01) : 1.0);
  }

  // ì˜¤í† ëª¨ë“œì‹œ: ì˜¤ë¥¸ìª½ í´ë¦­(e.button===2)ì—ì„œëŠ” ê²½ê³  ë„ìš°ì§€ ì•ŠìŒ!
  if (autoOrb) {
    if (e.button !== 2) showAutoWarning();
    return;
  }




  if (autoOrb) { showAutoWarning(); return; }
  if (autoOrb) return; // ì˜¤í†  ONì´ë©´ ë¬´ì‹œ
  if (e.button !== 0 || player.state === "attack" || player.state === "dead") return;
  if (player.mp < 3) return;
  let cam = getCamera();
  let mouseX = e.clientX + cam.x;
  let mouseY = e.clientY + cam.y;
  let dir = getDirectionFromMouse(player.x, player.y, mouseX, mouseY, player.dir);
  player.dir = dir; // ì¦‰ì‹œ ë°˜ì˜!
  socket.emit("attack", { mouseX, mouseY, dir });
    let snd = document.getElementById('attackSound');
  if (snd) {
    snd.currentTime = 0; // ì—°íƒ€ì‹œ í•­ìƒ ì²˜ìŒë¶€í„°
    snd.play();
  }
});





let lastOrbReq = 0;

    // ì´ë™/ìƒíƒœ ì—…ë°ì´íŠ¸
    
      function update() {

  // 1. ì˜¤í† ëª¨ë“œë©´, í•­ìƒ mouseScreen ê°’ì„ ì˜¤í† íƒ€ê²Ÿìœ¼ë¡œ ë®ì–´ì“°ê¸°!
  
  if (autoOrb && player) {
  let cam = getCamera();
  let target = null;
  let targetType = "";
  let minDist = 999999;

  // â­ 1. 1000í”½ì…€ ì´ë‚´ ì˜¤ë¸Œ ë¨¼ì € íƒìƒ‰
  let nearestOrb = null, orbDist = 999999;
  for (let orb of orbs) {
    let dx = orb.x - player.x, dy = orb.y - player.y;
    let dist = Math.sqrt(dx*dx + dy*dy);
    if (dist < 1000 && dist < orbDist) {
      orbDist = dist;
      nearestOrb = orb;
    }
  }
  if (nearestOrb) {
    target = nearestOrb;
    targetType = "orb";
    minDist = orbDist;
  } else {
    // â­ 2. ì˜¤ë¸Œê°€ ì—†ìœ¼ë©´ ëª¬ìŠ¤í„° íƒìƒ‰ (ê¸°ì¡´ëŒ€ë¡œ)
    for (let b of butterflies) {
      if (b.state !== "dead" && b.hp > 0) {
        let dx = b.x - player.x, dy = b.y - player.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < minDist) {
          minDist = dist;
          target = b;
          targetType = "monster";
        }
      }
    }
  }
  // ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ê¸°ì¡´ê³¼ ë™ì¼!
  if (target) {
    if (targetType === "monster") {
      let dx = target.x - player.x, dy = target.y - player.y, dist = Math.sqrt(dx*dx + dy*dy);
      if (dist > 500) {
        mouseScreen.x = target.x - cam.x;
        mouseScreen.y = target.y - cam.y;
      } else {
        mouseScreen.x = player.x - cam.x;
        mouseScreen.y = player.y - cam.y;
      }
      if (dist < 500) {
        const now = Date.now();
        if (now >= playerAttackCooldownEnd && player.state !== "attack" && player.state !== "dead") {
          socket.emit("attack", {
            dir: dx > 0 ? "right" : "left",
            mouseX: target.x,
            mouseY: target.y
          });
          playerAttackCooldownEnd = now + 1000 / (statLevels.aspd ? (1 + statLevels.aspd * 0.01) : 1.0);
        }
      }
    } else if (targetType === "orb") {
      mouseScreen.x = target.x - cam.x;
      mouseScreen.y = target.y - cam.y;
      let dx = target.x - player.x, dy = target.y - player.y, dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < 19) socket.emit("pickupOrb", target.id);
    }
  } else {
    // íƒ€ê²Ÿ ì—†ìœ¼ë©´ ëŒ€ê¸°
    mouseScreen.x = MAP_SIZE/2 - cam.x;
    mouseScreen.y = MAP_SIZE/2 - cam.y;
    requestOrbs();
  }
}









      if (Date.now() - lastOrbReq > 400) {
        requestOrbs();
        lastOrbReq = Date.now();
        }

         // ë§¤ í”„ë ˆì„ë§ˆë‹¤ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë¥¼ ì›”ë“œ ì¢Œí‘œë¡œ ë³€í™˜í•´ì„œ ê°±ì‹ 
  let cam = getCamera();
  mouseWorld = {
    x: mouseScreen.x + cam.x,
    y: mouseScreen.y + cam.y
  };

      let moved = false;
     speed = player.mspd || 2; // ì„œë²„ì—ì„œ ë°›ì€ mspd ê°’ì„ í•­ìƒ ì‚¬ìš©
     if (rightMouseDown && player.mp > 0) speed *= 2; // ë‹¬ë¦¬ê¸° ì‹œ 2ë°°



   const STOP_DISTANCE = 60; // ì›í•˜ëŠ” ê±°ë¦¬(px)

if (player.state !== "attack" && player.state !== "dead" && mouseWorld) {
  let dx = mouseWorld.x - player.x;
  let dy = mouseWorld.y - player.y;
  let dist = Math.sqrt(dx * dx + dy * dy);

  if (dist > STOP_DISTANCE) {
    player.x += dx / dist * speed;
    player.y += dy / dist * speed;
    moved = true;

    // ë°©í–¥ ê²°ì • (ì¢Œ/ìš° ë²”ìœ„ ë” ì¢í˜)
    const LR_PRIORITY = 0.1;
    if (Math.abs(dx) > LR_PRIORITY * Math.abs(dy)) {
      player.dir = dx > 0 ? "right" : "left";
    }
  }

  // ì—¬ê¸° ë°œì†Œë¦¬!
  if (moved && player.state !== "attack" && player.state !== "dead") {
    let footstepSound = document.getElementById("footstepSound");
    if (footstepSound && footstepSound.paused) {
      footstepSound.volume = 0.6;
      footstepSound.play();
    }
  }
}

      
    // ì˜¤ë¥¸ìª½ ë§ˆìš°ìŠ¤ ëˆ„ë¥¸ ë™ì•ˆ, MP -2ì”© ê¹ìŒ(0.2ì´ˆ ê°„ê²© ì¶”ì²œ)
  if (rightMouseDown && player.mp > 0) {
    mpTick++;
    if (mpTick >= 12) { // ì•½ 0.2ì´ˆë§ˆë‹¤ (60fps ê¸°ì¤€)
      socket.emit("mpDown", 2); // ì„œë²„ì— MP ê¹ì•„ë‹¬ë¼ê³  ìš”ì²­
      mpTick = 0;
    }
  } else {
    mpTick = 0;
  }


  // update() í•¨ìˆ˜ ì•ˆìª½ (í”Œë ˆì´ì–´ ìƒíƒœ/ì´ë™ ì²˜ë¦¬ ì´í›„ì—!)
if (autoOrb && window.orbs && player) {
  for (let orb of orbs) {
    let dx = orb.x - player.x, dy = orb.y - player.y;
    let dist = Math.sqrt(dx*dx + dy*dy);
    // êµ¬ìŠ¬ ê·¼ì²˜(19px) ì´ë‚´ë©´ ë°”ë¡œ ë¨¹ê¸°
    if (dist < 19) {
      socket.emit("pickupOrb", orb.id);
      break; // í•œ ë²ˆë§Œ!
    }
  }
}

updateEvadeParticles();




      // ë§µ ë°˜ë³µ ì›Œí”„ì¡´ íš¨ê³¼!
if (player.x < 0) player.x = MAP_SIZE;
if (player.x > MAP_SIZE) player.x = 0;
if (player.y < 0) player.y = MAP_SIZE;
if (player.y > MAP_SIZE) player.y = 0;



      // ì‚¬ë§(Xí‚¤)
      if ((keys["x"] || keys["X"]) && player.state !== "dead") {
        player.state = "dead"; player.frame = 0; player.animTimer = 0;

      }
        else if (player.state === "dead") {
        let spd = 6;
        if (++player.animTimer >= spd) {
          player.animTimer = 0;
          if (player.frame < FRAMES-1) player.frame++;

      
        }
        // ì£½ìœ¼ë©´ ë§ˆì§€ë§‰ í”„ë ˆì„ ê³ ì •
        if (player.frame >= FRAMES-1) player.frame = FRAMES-1;
      }
      
      socket.emit("update", {
  x: player.x, y: player.y, dir: player.dir
  // state: player.state, frame: player.frame  <<== ì‚­ì œ!
});


// ìš°ì¸¡ìƒë‹¨ ë§µì¢Œí‘œ íŒ¨ë„ ì‹¤ì‹œê°„ ê°±ì‹ !
document.getElementById("mapCoordText").textContent =
  `${Math.round(player.x)}:${Math.round(player.y)}`;


    }

    

    // ì¹´ë©”ë¼
    function getCamera() {
      return { x: player.x - canvas.width / 2, y: player.y - canvas.height / 2 };
    }

    // í”Œë ˆì´ì–´ë³„ ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ì €ì¥
    let animFrames = {};

    function drawPlayers() {
      Object.entries(allPlayers).forEach(([id, p]) => {
        if (!p) return;

        // ì¹´ë©”ë¼ ê¸°ì¤€ ì¢Œí‘œ ë³€í™˜
               let px = Math.round(p.x - (player.x - canvas.width/2));
               let py = Math.round(p.y - (player.y - canvas.height/2));

          
    if (id === myId && glowTimer > 0) {
      ctx.save();
      ctx.globalAlpha = 0.60 * (glowTimer/18); // ì‚¬ë¼ì§€ëŠ” íš¨ê³¼
      ctx.beginPath();
      ctx.arc(px, py, 56 + glowTimer*1.5, 0, Math.PI*2);
      let grad = ctx.createRadialGradient(px, py, 22, px, py, 56 + glowTimer*1.5);
      grad.addColorStop(0.1, "#ffe26d99");
      grad.addColorStop(0.4, "#ffe26d33");
      grad.addColorStop(1.0, "rgba(255,240,120,0)");
      ctx.fillStyle = grad;
      ctx.shadowColor = "#ffe26d";
      ctx.shadowBlur = 22 + glowTimer*0.7;
      ctx.fill();
      ctx.restore();
    }
      

    // drawPlayers í•¨ìˆ˜ ë‚´ë¶€ (ë‹‰ë„¤ì„ ìœ„ì— ì¶”ê°€)
ctx.save();
ctx.globalAlpha = 0.94;
ctx.font = "bold 15px Pretendard, Arial";
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.fillStyle = "#ffd465";
ctx.shadowColor = "#000";
ctx.shadowBlur = 2.2;
ctx.fillText(`ë ˆë²¨: ${p.level ?? 1}`, px, py - 49); // ë‹‰ë„¤ì„ë³´ë‹¤ ìœ„(y-49)
ctx.restore();


    // drawPlayers í•¨ìˆ˜ ë‚´ë¶€ (ê° p ê·¸ë¦° í›„)
      ctx.font = "bold 16px sans-serif";
      ctx.textAlign = "center";
      ctx.fillStyle = id === myId ? "#fff" : "#ff3333";
      const name = p.name || (id === myId ? nickname : id.slice(0, 8));
      ctx.fillText(name, px, py - 28);


        // ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ, ë°©í–¥
        let dir = p.dir === "left" ? 1 : 0;
        let state = p.state || "idle";

        // ìŠ¤í”„ë¼ì´íŠ¸ y ì¸ë±ìŠ¤
        let sy = 0;
        if (state === "move") sy = dir;
        else if (state === "idle") sy = dir+2;
        else if (state === "attack") sy = dir+4;
        else if (state === "dead") sy = 6;

        // ë‚´ í”Œë ˆì´ì–´ëŠ” update()ì—ì„œ ì§ì ‘ í”„ë ˆì„ì„ ëŒë¦¼
        // íƒ€ ìœ ì €ë§Œ ë™ê¸°í™” ë°ì´í„° ê¸°ë°˜ ì• ë‹ˆë©”ì´ì…˜
        let frame = 0;
        if (id === myId) {
          frame = player.frame;
        } else {
          if (!animFrames[id]) animFrames[id] = { frame: 0, animTimer: 0 };
          let anim = animFrames[id];
          let spd = 0;
          if (state === "move") spd = 4;
          else if (state === "idle") spd = 10;
          else if (state === "attack") spd = 3;
          else if (state === "dead") spd = 6;

          if (state !== "dead") {
            if (++anim.animTimer >= spd) {
              anim.animTimer = 0;
              if (state === "attack") {
                if (anim.frame < FRAMES-1) anim.frame++;
              } else {
                anim.frame = (anim.frame+1)%FRAMES;
              }
            }
          } else {
            if (anim.frame < FRAMES-1) anim.frame++;
          }
          // ê³µê²©/ì‚¬ë§ ì™¸ì—ëŠ” ë™ê¸°í™”ëœ í”„ë ˆì„ ì‚¬ìš©
          if (state !== "attack" && state !== "dead") {
            anim.frame = typeof p.frame === "number" ? p.frame : anim.frame;
          }
          frame = anim.frame;
        }


          

        let sx = frame * SPRITE_SIZE;

      


      ctx.drawImage(
        scoutImg,
            sx, sy*SPRITE_SIZE, SPRITE_SIZE, SPRITE_SIZE,
            px - SPRITE_SIZE/2, py - SPRITE_SIZE/2, SPRITE_SIZE, SPRITE_SIZE
        );

      });

    }
    



    ctx.imageSmoothingEnabled = false;

  // === ìŠ¤í‚¬ ì‹œì „ í•¨ìˆ˜ (ë°˜ë“œì‹œ ì „ì—­!)
function castSkill(skillNum) {
  let cam = getCamera();
  let mouseX = mouseScreen.x + cam.x;
  let mouseY = mouseScreen.y + cam.y;
  let dir = getDirectionFromMouse(player.x, player.y, mouseX, mouseY, player.dir);
  player.dir = dir; // ì¦‰ì‹œ ë°˜ì˜!
  socket.emit("castSkill", { skill: skillNum, mouseX, mouseY, dir });
}

// === ìŠ¤í‚¬ ë‹¨ì¶•í‚¤(1,2) & ì¿¨/ë§ˆë‚˜ ì²´í¬
// === ìŠ¤í‚¬ ë‹¨ì¶•í‚¤(1,2)
window.addEventListener("keydown", function(e) {
  if (autoOrb) { showAutoWarning(); return; }
  if (autoOrb) return;
  if (document.activeElement === chatInput) return;
  if (player.state === "attack" || player.state === "dead") return;
  let now = Date.now();

  if (e.key === "1") {
    if (skillCooldowns[0] > now || player.mp < 20) return;
    castSkill(1);
    // === ì—¬ê¸°! 1ë²ˆ ìŠ¤í‚¬(ê°•ê²©) íš¨ê³¼ìŒ ì¬ìƒ ===
    let snd = document.getElementById('skill1Sound');
    if (snd) {
      snd.currentTime = 0;
      snd.play();
    }
  }

  if (e.key === "2") {
    if (skillCooldowns[1] > now || player.mp < 30) return;
    castSkill(2);
    let snd = document.getElementById('skill2Sound');
    if (snd) {
      snd.currentTime = 0;
      snd.play();
    }
  }
});



function drawButterflies(cam) {
  butterflies.forEach(b => {
    if (b.state === "dead") {
      ctx.save();
      let alpha = 1.0;
      if (b.deadTimer !== undefined)
        alpha = Math.max(0, 1 - (b.deadTimer || 0) / 60);
      ctx.globalAlpha = alpha;
      drawButterflyDead(ctx, b.x, b.y, 3, cam);
      ctx.globalAlpha = 1;
      ctx.restore();
    } else {
      drawButterflyMove(ctx, b.x, b.y, b.dir, b.frame, cam);
      drawButterflyStatus(ctx, b, cam); // HPë°” + ì´ë¦„ í•œë²ˆì—
    }
  });
}

function drawButterflyStatus(ctx, b, cam) {
  // ì¤‘ì‹¬ ì¢Œí‘œ
  let bx = b.x - cam.x;
  let by = b.y - cam.y - BUTTERFLY_SIZE * 0.65;
  let width = 34, height = 6;
  let ratio = Math.max(0, Math.min(1, b.hp / b.maxHp));
  ctx.save();

  // 1. HPë°” (ë§¨ ìœ„)
  ctx.globalAlpha = 0.92;
  ctx.shadowBlur = 0;
  ctx.fillStyle = "#211a22";
  ctx.fillRect(bx - width/2 - 1, by - 32, width+2, height+2); // HPë°” yìœ„ì¹˜: by - 32
  ctx.fillStyle = "#ff7272";
  ctx.fillRect(bx - width/2, by - 31, width * ratio, height);
  ctx.strokeStyle = "#fff";
  ctx.lineWidth = 1.2;
  ctx.strokeRect(bx - width/2 - 1, by - 32, width+2, height+2);

  // 2. ì´ë¦„ (HPë°” ë°”ë¡œ ì•„ë˜)
  ctx.font = 'bold 18px Pretendard, Arial, sans-serif';
  ctx.textAlign = "center";
  ctx.textBaseline = "bottom";
  ctx.fillStyle = "#ffd8fa";
  ctx.shadowColor = "#ad66c5";
  ctx.shadowBlur = 5;
  ctx.fillText("íŒ…ì»¤ë²¨", bx, by - 1); // HPë°” ë°”ë¡œ ì•„ë˜

  ctx.restore();
}






    // ë©”ì¸ë£¨í”„
    function draw() {
      updateOrbs();
      update();
    
      let cam = getCamera();

  


      // ë°”ë‹¥ íƒ€ì¼
      for (
        let y = -TILE_SIZE; y < canvas.height + TILE_SIZE; y += TILE_SIZE
      ) {
        for (
          let x = -TILE_SIZE; x < canvas.width + TILE_SIZE; x += TILE_SIZE
        ) {
          let mapX = Math.floor((x + cam.x) / TILE_SIZE) * TILE_SIZE;
          let mapY = Math.floor((y + cam.y) / TILE_SIZE) * TILE_SIZE;
          ctx.drawImage(
            grassImg,
            mapX - cam.x,
            mapY - cam.y,
            TILE_SIZE, TILE_SIZE
          );
        }
      }
     

   function drawArrows(cam) {
  for (let i = arrows.length - 1; i >= 0; i--) {
    let a = arrows[i];

    // hitFadeëŠ” ê¸°ì¡´ëŒ€ë¡œ ì‚¬ìš©
    if (a.hitFade) {
      a.alpha -= 0.08;
      if (a.alpha <= 0.05) {
        arrows.splice(i, 1);
        continue;
      }
    }

    // ì´ë™
    a.x += a.vx;
    a.y += a.vy;
    a.life -= Math.sqrt(a.vx * a.vx + a.vy * a.vy);

    // ì• ë‹ˆë©”ì´ì…˜
    a.frameTimer = (a.frameTimer || 0) + 1;
    if (a.frameTimer > 4) {
      a.frame = ((a.frame || 0) + 1) % ARROW_FRAME_COUNT;
      a.frameTimer = 0;
    }

    // === ë‚˜ë¹„(ëª¬ìŠ¤í„°) ì¶©ëŒ ì²´í¬ ===
    let hitSomething = false;
    for (let j = 0; j < butterflies.length; j++) {
      let b = butterflies[j];
      if (b.state === "dead" || b.hp <= 0) continue;
      let dx = b.x - a.x, dy = b.y - a.y;
      let dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < (b.hitbox?.radius || 22)) {
        arrows.splice(i, 1);
        hitSomething = true;
        break;
      }
    }
    if (hitSomething) continue;

    // === íƒ€ í”Œë ˆì´ì–´ ì¶©ëŒ ì²´í¬ (ë‚´ê°€ ìœ í™”ì‚´ë§Œ) ===
    if (a.shooterId === myId) {
      let hitPlayer = false;
      Object.entries(allPlayers).forEach(([id, p]) => {
        if (id === myId || hitPlayer) return;
        let dx = p.x - a.x, dy = p.y - a.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 26) {
          arrows.splice(i, 1);
          hitPlayer = true;
        }
      });
      if (hitPlayer) continue;
    }

    // === (ì—¬ê¸°!) ìƒëŒ€ë°© í™”ì‚´ì´ ë‚´ ìºë¦­í„°ì— ëª…ì¤‘í•˜ë©´ ì¦‰ì‹œ íˆ¬ëª…+ì‚­ì œ ===
    if (a.shooterId !== myId) {
      let dx = player.x - a.x;
      let dy = player.y - a.y;
      let dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < 26) {
        a.alpha = 0;              // ì¦‰ê° íˆ¬ëª…!
        arrows.splice(i, 1);      // ì¦‰ì‹œ ì‚­ì œ!
        continue;                 // ë‹¤ìŒ í™”ì‚´
      }
    }

    ctx.save();
    if (a.shooterId !== myId) {
      ctx.globalAlpha = 0.3;
    } else {
      ctx.globalAlpha = a.alpha ?? 0.92;
    }
    ctx.translate(a.x - cam.x, a.y - cam.y);
    ctx.rotate((a.angle || 0) - Math.PI/2 + Math.PI);
    ctx.drawImage(
      arrowImg,
      a.frame * ARROW_FRAME_W, 0, ARROW_FRAME_W, ARROW_FRAME_H,
      -ARROW_FRAME_W/2, -ARROW_FRAME_H/2, ARROW_FRAME_W, ARROW_FRAME_H
    );
    ctx.restore();

    if (a.hitFade) {
      a.alpha = (a.alpha || 0.92) * 0.86;
      if (a.alpha < 0.07) arrows.splice(i, 1);
    }

    if (a.life < 0) arrows.splice(i, 1);
  }
}









     
      // === ê½ƒ ê·¸ë¦¬ê¸° ===
function drawFlowers(flowerArr, img, cam) {
  flowerArr.forEach(f => {
    const sx = f.x - cam.x - img.width / 2;
    const sy = f.y - cam.y - img.height + 10; // ë‚˜ë¬´ë³´ë‹¤ ì¢€ ë” ë‚®ê²Œ
    ctx.drawImage(img, sx, sy);
  });
}

// draw í•¨ìˆ˜ ì•ˆì—ì„œ í˜¸ì¶œ (cam ë³€ìˆ˜ ì´ë¯¸ ì„ ì–¸ë˜ì–´ ìˆìŒ)
drawFlowers(yellowFlowers, yellowFlowerImg, cam);
drawFlowers(redFlowers, redFlowerImg, cam);
drawFlowers(blueFlowers, blueFlowerImg, cam);
drawFlowers(whiteFlowers, whiteFlowerImg, cam);



     // ë¶ˆí™”ì‚´ ë¨¼ì € ê·¸ë¦¼
      
      updateLevelupParticles(); // â† ì¶”ê°€!
  
      drawLevelupParticles(cam); // â† ì¶”ê°€!

      drawOrbs(cam);   // drawPlayers() ì „ì— ì¶”ê°€!
      checkOrbPickup(); // draw()ì—ì„œ í˜¸ì¶œ!

      drawEvadeParticles(cam);
      drawArrows(cam);

      updateHitParticles();
      updateDamageParticles();
    

      drawHitParticles(cam);  // í”Œë ˆì´ì–´ë“¤(ìŠ¤í”„ë¼ì´íŠ¸)
      
       drawPlayers();
      drawButterflies(cam);
      drawButterflyProjectiles(cam);

      drawDamageParticles(cam);

     
      

     

      

      
      
      // === draw í•¨ìˆ˜ ë‚´ì— butterflies ëª¬ìŠ¤í„° ê·¸ë¦¬ê¸° ===




       // ë‚˜ë¬´
      trees.forEach(tree => {
        ctx.drawImage(
          treeImg,
          tree.x - cam.x - treeImg.width / 2,
          tree.y - cam.y - treeImg.height
        );
      });

      // --- ë°ì‹œë³´ë“œ í”„ë ˆì„ ---
const dashW = 500, dashH = 200;
const dashX = (canvas.width - dashW) / 2;
const dashY = canvas.height - dashH + 10;
ctx.save();
ctx.globalAlpha = 1.0;
ctx.drawImage(dashboardImg, dashX, dashY, dashW, dashH);
ctx.restore();
      

const hpX = 520, hpY = canvas.height - 95;
const mpX = canvas.width - 520, mpY = canvas.height - 95;
// [HP] ë‘¥ê·¼ ê³µ
const hpRatio = Math.max(0, Math.min(1, player.hp / player.maxHp));
// --- HP ì˜¤ë¸Œ(ë””ì•„ ê°ì„±) ---
const circleR = 53; // ì‚´ì§ í‚¤ì›€
const orbShadow = 10; // ê·¸ë¦¼ì ê¹Šì´



// 1. ì–´ë‘ìš´ ìŒì˜(ì™¸ê³½+ì¤‘ì‹¬)
ctx.save();
let grad = ctx.createRadialGradient(hpX, hpY, circleR-25, hpX, hpY, circleR+orbShadow);
grad.addColorStop(0, "#6d0000");
grad.addColorStop(0.35, "#ae1818");
grad.addColorStop(0.7, "#460808");
grad.addColorStop(1, "#220202a0");
ctx.beginPath();
ctx.arc(hpX, hpY, circleR+orbShadow, 0, Math.PI*2);
ctx.fillStyle = grad;
ctx.globalAlpha = 1.0;
ctx.fill();
ctx.restore();

// 2. HP ê²Œì´ì§€ ì±„ìš°ê¸° (ì§„í•œ ë¶‰ì€ arc)
ctx.save();
ctx.beginPath();
ctx.arc(hpX, hpY, circleR-7, 0, Math.PI*2);
ctx.closePath();
ctx.clip();

let hpFillH = 2*(circleR-7) * hpRatio;
let topY = hpY + (circleR-7) - hpFillH;
let hpBarGrad = ctx.createLinearGradient(hpX, hpY - (circleR-7), hpX, hpY + (circleR-7));
hpBarGrad.addColorStop(0, "#ffadad");
hpBarGrad.addColorStop(0.3, "#f12836");
hpBarGrad.addColorStop(1, "#990a0a");
ctx.globalAlpha = 0.98;
ctx.fillStyle = hpBarGrad;
ctx.fillRect(hpX-(circleR-7), topY, 2*(circleR-7), hpFillH);
ctx.restore();

// 3. ì˜¤ë¸Œ í…Œë‘ë¦¬ (ê´‘íƒ)
ctx.save();
ctx.beginPath();
ctx.arc(hpX, hpY, circleR, 0, Math.PI*2);
ctx.lineWidth = 5.5;
ctx.strokeStyle = "#fff5";
ctx.shadowColor = "#ff8088";
ctx.shadowBlur = 12;
ctx.globalAlpha = 0.38;
ctx.stroke();
ctx.restore();

// 4. ìƒë‹¨ í•˜ì´ë¼ì´íŠ¸(ë¹› ë°˜ì‚¬ ëŠë‚Œ)
ctx.save();
ctx.globalAlpha = 0.27;
ctx.beginPath();
ctx.arc(hpX, hpY-circleR/2.5, circleR/1.7, Math.PI*0.9, Math.PI*2.1, false);
ctx.strokeStyle = "#fff";
ctx.lineWidth = 8;
ctx.shadowColor = "#fff";
ctx.shadowBlur = 14;
ctx.stroke();
ctx.restore();

// 5. HP í…ìŠ¤íŠ¸
ctx.save();
ctx.font = "bold 20px 'Pretendard', Arial, sans-serif";
ctx.fillStyle = "#fff";
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.shadowColor = "#c23";
ctx.shadowBlur = 8;
ctx.fillText(`${player.hp} / ${player.maxHp}`, hpX, hpY+5);
ctx.shadowBlur = 0;
ctx.restore();

const mpRatio = Math.max(0, Math.min(1, player.mp / player.maxMp));

// --- MP ì˜¤ë¸Œ(ë””ì•„ ê°ì„±) ---
let mpGrad = ctx.createRadialGradient(mpX, mpY, circleR-25, mpX, mpY, circleR+orbShadow);
mpGrad.addColorStop(0, "#173c72");
mpGrad.addColorStop(0.35, "#1672ca");
mpGrad.addColorStop(0.7, "#061236");
mpGrad.addColorStop(1, "#10203ba0");

// 1. ì–´ë‘ìš´ ìŒì˜(ì™¸ê³½+ì¤‘ì‹¬)
ctx.save();
ctx.beginPath();
ctx.arc(mpX, mpY, circleR+orbShadow, 0, Math.PI*2);
ctx.fillStyle = mpGrad;
ctx.globalAlpha = 1.0;
ctx.fill();
ctx.restore();

// 2. MP ê²Œì´ì§€ ì±„ìš°ê¸° (ì§„í•œ íŒŒë‘ arc)
// ----- MP ì˜¤ë¸Œ (ìœ„ì—ì„œ ì•„ë˜ë¡œ) -----
// (1) ì–´ë‘ìš´ ìŒì˜(ì™¸ê³½+ì¤‘ì‹¬)
let mpRadialGrad = ctx.createRadialGradient(mpX, mpY, circleR-25, mpX, mpY, circleR+orbShadow);
mpRadialGrad.addColorStop(0, "#173c72");
mpRadialGrad.addColorStop(0.35, "#1672ca");
mpRadialGrad.addColorStop(0.7, "#061236");
mpRadialGrad.addColorStop(1, "#10203ba0");

ctx.save();
ctx.beginPath();
ctx.arc(mpX, mpY, circleR+orbShadow, 0, Math.PI*2);
ctx.fillStyle = mpRadialGrad;
ctx.globalAlpha = 1.0;
ctx.fill();
ctx.restore();

// (2) MP ê²Œì´ì§€ (ìœ„ì—ì„œ ì•„ë˜ë¡œ!)
ctx.save();
ctx.beginPath();
ctx.arc(mpX, mpY, circleR-7, 0, Math.PI*2);
ctx.closePath();
ctx.clip();

let mpFillH = 2*(circleR-7) * mpRatio;
let mpTopY = mpY + (circleR-7) - mpFillH;

// â—ì—¬ê¸°ì„œ Linearë¡œ! (ì¤‘ë³µ ë³€ìˆ˜ëª… ë°©ì§€)
let mpBarGrad = ctx.createLinearGradient(mpX, mpY - (circleR-7), mpX, mpY + (circleR-7));
mpBarGrad.addColorStop(0, "#e2fdff");
mpBarGrad.addColorStop(0.3, "#39c6ff");
mpBarGrad.addColorStop(1, "#0955aa");
ctx.globalAlpha = 0.96;
ctx.fillStyle = mpBarGrad;
ctx.fillRect(mpX-(circleR-7), mpTopY, 2*(circleR-7), mpFillH);
ctx.restore();



// 3. ì˜¤ë¸Œ í…Œë‘ë¦¬ (ê´‘íƒ)
ctx.save();
ctx.beginPath();
ctx.arc(mpX, mpY, circleR, 0, Math.PI*2);
ctx.lineWidth = 5.5;
ctx.strokeStyle = "#fff8";
ctx.shadowColor = "#38e2ff";
ctx.shadowBlur = 11;
ctx.globalAlpha = 0.36;
ctx.stroke();
ctx.restore();

// 4. ìƒë‹¨ í•˜ì´ë¼ì´íŠ¸(ë¹› ë°˜ì‚¬ ëŠë‚Œ)
ctx.save();
ctx.globalAlpha = 0.18;
ctx.beginPath();
ctx.arc(mpX, mpY-circleR/2.5, circleR/1.7, Math.PI*0.9, Math.PI*2.1, false);
ctx.strokeStyle = "#fff";
ctx.lineWidth = 8;
ctx.shadowColor = "#fff";
ctx.shadowBlur = 13;
ctx.stroke();
ctx.restore();

// 5. MP í…ìŠ¤íŠ¸
ctx.save();
ctx.font = "bold 20px 'Pretendard', Arial, sans-serif";
ctx.fillStyle = "#fff";
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.shadowColor = "#2488c2";
ctx.shadowBlur = 8;
ctx.fillText(`${player.mp} / ${player.maxMp}`, mpX, mpY+5);
ctx.shadowBlur = 0;
ctx.restore();

// --- ìº”ë²„ìŠ¤ í•˜ë‹¨ ì¤‘ì•™ì— EXP ë°” ---
const expBarW = 208, expBarH = 20;
const expBarX = (canvas.width - expBarW) / 2;
const expBarY = canvas.height - expBarH; // ë°”ë¡œ í•˜ë‹¨ì— ë”±!

const expRatio = Math.max(0, Math.min(1, player.exp / player.maxExp));

// ë‹¤í¬+ìœ ê´‘ ë°°ê²½
ctx.save();
let barGrad = ctx.createLinearGradient(expBarX, expBarY, expBarX + expBarW, expBarY + expBarH);
barGrad.addColorStop(0, "#18181b");
barGrad.addColorStop(0.4, "#26263c");
barGrad.addColorStop(1, "#10101a");
ctx.fillStyle = barGrad;
ctx.globalAlpha = 0.94;
ctx.fillRect(expBarX, expBarY, expBarW, expBarH);

// ì™¸ê³½ì„ (ë„¤ì˜¨)
ctx.globalAlpha = 1.0;
ctx.lineWidth = 3.2;
ctx.strokeStyle = "#4537aa";
ctx.shadowColor = "#44f9ffcc";
ctx.shadowBlur = 11;
ctx.strokeRect(expBarX, expBarY, expBarW, expBarH);

// ê²½í—˜ì¹˜ ì±„ìš°ê¸° (êµ¬ìŠ¬ ìƒ‰ìƒê³¼ ë™ì¼)
let fillGrad = ctx.createLinearGradient(expBarX, expBarY, expBarX + expBarW, expBarY + expBarH);
fillGrad.addColorStop(0, "#ffe146");
fillGrad.addColorStop(0.65, "#ffc42c");
fillGrad.addColorStop(1, "#ff8631");
ctx.globalAlpha = 0.97;
ctx.fillStyle = fillGrad;
ctx.fillRect(expBarX + 2, expBarY + 2, (expBarW - 4) * expRatio, expBarH - 4);


// í…ìŠ¤íŠ¸
ctx.globalAlpha = 1.0;
ctx.font = "bold 15px Pretendard, Arial, sans-serif";
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.fillStyle = "#eaffff";
ctx.shadowColor = "#23263e";
ctx.shadowBlur = 2.2;
ctx.fillText(`EXP  ${player.exp} / ${player.maxExp}`, expBarX + expBarW / 2, expBarY + expBarH / 2);
ctx.restore();

function drawSkillSlot(x, y, num, selected, cooldown, total) {
  // 1. ìŠ¬ë¡¯ í…Œë‘ë¦¬ (ê¸°ì¡´ ì½”ë“œ)
  ctx.save();
  ctx.globalAlpha = 0.97;
  ctx.lineWidth = selected ? 4 : 2.6;
  ctx.strokeStyle = selected ? "#ffe44a" : "#eeeefa";
  ctx.shadowColor = selected ? "#ffecb2" : "#b7e7ff";
  ctx.shadowBlur = selected ? 10 : 4;
  ctx.beginPath();
  const radius = 12;
  ctx.moveTo(x + radius, y);
  ctx.lineTo(x + 50 - radius, y);
  ctx.quadraticCurveTo(x + 50, y, x + 50, y + radius);
  ctx.lineTo(x + 50, y + 50 - radius);
  ctx.quadraticCurveTo(x + 50, y + 50, x + 50 - radius, y + 50);
  ctx.lineTo(x + radius, y + 50);
  ctx.quadraticCurveTo(x, y + 50, x, y + 50 - radius);
  ctx.lineTo(x, y + radius);
  ctx.quadraticCurveTo(x, y, x + radius, y);
  ctx.closePath();
  ctx.stroke();
  ctx.restore();

  // === [â˜…ì—¬ê¸°ì— ì¶”ê°€!] ì¿¨íƒ€ì„ ì›í˜• ê²Œì´ì§€ ===
  if (cooldown > 0 && total > 0) {
    const ratio = Math.max(0, Math.min(1, cooldown / total));
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(x + 25, y + 25);
    ctx.arc(
      x + 25, y + 25, 23, // ì¤‘ì‹¬, ë°˜ì§€ë¦„
      -Math.PI / 2,
      -Math.PI / 2 + 2 * Math.PI * ratio,
      false
    );
    ctx.closePath();
    ctx.globalAlpha = 0.40;
    ctx.fillStyle = "#255c97";
    ctx.fill();

    // ì™¸ê³½ ë¼ì¸
    ctx.beginPath();
    ctx.arc(
      x + 25, y + 25, 23.7,
      -Math.PI / 2,
      -Math.PI / 2 + 2 * Math.PI * ratio,
      false
    );
    ctx.lineWidth = 5.2;
    ctx.strokeStyle = "#59deff";
    ctx.globalAlpha = 0.7;
    ctx.stroke();
    ctx.restore();
  }
  // === [ì—¬ê¸°ê¹Œì§€] ===

  // 2. ìˆ«ì
  ctx.save();
  ctx.font = "bold 14px Pretendard, Arial, sans-serif";
  ctx.fillStyle = "#ffe970";
  ctx.textAlign = "right";
  ctx.textBaseline = "top";
  ctx.shadowColor = "#2c2a1f";
  ctx.shadowBlur = 4;
  ctx.globalAlpha = 0.93;
  ctx.fillText(num, x + 50 - 6, y + 2);
  ctx.restore();
}



// skillCooldowns = [íƒ€ì„ìŠ¤íƒ¬í”„1, íƒ€ì„ìŠ¤íƒ¬í”„2] (ì „ì—­)
const now = Date.now();

const slot1Cooldown = Math.max(0, skillCooldowns[0] - now);
const slot2Cooldown = Math.max(0, skillCooldowns[1] - now);

// ì˜ˆ: ì¿¨íƒ€ì„ ì „ì²´(ms)
const slot1Total = 3000; // 3ì´ˆ
const slot2Total = 3000; // 5ì´ˆ
// ìŠ¤í‚¬ìŠ¬ë¡¯ ìœ„ì¹˜
const slotY = expBarY - 58; // ê²½í—˜ì¹˜ë°” ìœ„ì— 58px ë„ìš°ê¸°(ì ë‹¹íˆ ì¡°ì ˆ)
const slot1X = expBarX - -30; // ê²½í—˜ì¹˜ë°” ì¢Œì¸¡ì—
const slot2X = expBarX + expBarW - 84; // ê²½í—˜ì¹˜ë°” ìš°ì¸¡ì—

// draw í•¨ìˆ˜(ê²Œì„ ë£¨í”„ì—ì„œ ë§¤ í”„ë ˆì„ë§ˆë‹¤ í˜¸ì¶œë˜ëŠ” ê³³)ì— ì•„ë˜ ì½”ë“œ ì‚½ì…!


// ì•„ì´ì½˜ë„ ìœ„ì— ê·¸ë ¤ì£¼ê¸°
ctx.drawImage(skillIcon1, slot1X, slotY, 50, 50);
ctx.drawImage(skillIcon2, slot2X, slotY, 50, 50);

// drawSkillSlot(x, y, num, selected, cooldown, total)
drawSkillSlot(slot1X, slotY, 1, false, slot1Cooldown, slot1Total);
drawSkillSlot(slot2X, slotY, 2, false, slot2Cooldown, slot2Total);

// === ì„œë²„ì—ì„œ ìŠ¤í‚¬ ì¿¨íƒ€ì„ ì •ë³´ ë°›ê¸° ===
socket.on("skillCooldown", ({skill, cooldownEnd}) => {
  skillCooldowns[skill - 1] = cooldownEnd;
});


      
      if (glowTimer > 0) glowTimer--;

      drawStatusBars();
      drawMinimap();


      function drawMinimap() {
  // ë¯¸ë‹ˆë§µ ì„¤ì •
  const radius = 84; // ë¯¸ë‹ˆë§µ ë°˜ì§€ë¦„(px)
  const border = 4;
  const centerX = canvas.width - radius - 28;
  const centerY = radius + 26;
  const worldView = 3000; // ë¯¸ë‹ˆë§µì— í‘œì‹œë˜ëŠ” ì›”ë“œ ë²”ìœ„(í•œ ë³€ ê¸¸ì´)
  const mapScale = radius / worldView * 0.9; // ì  ìœ„ì¹˜ ë³´ì •ìš©

  ctx.save();
  // ë‘¥ê·¼ ë¯¸ë‹ˆë§µ ë§ˆìŠ¤í‚¹(clip)
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
  ctx.clip();

  // ë°˜íˆ¬ëª…í•œ ë°°ê²½
  ctx.globalAlpha = 0.64;
  ctx.fillStyle = "#222d";
  ctx.fillRect(centerX - radius, centerY - radius, radius * 2, radius * 2);

  // ë°”ê¹¥ ê·¸ë¼ë°ì´ì…˜ í…Œë‘ë¦¬
  ctx.globalAlpha = 1.0;
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
  let grad = ctx.createRadialGradient(centerX, centerY, radius * 0.6, centerX, centerY, radius);
  grad.addColorStop(0, "#88f2");
  grad.addColorStop(0.75, "#d3f1");
  grad.addColorStop(1, "#2229");
  ctx.strokeStyle = grad;
  ctx.lineWidth = border * 2;
  ctx.stroke();

  // ë¶ìª½(N) í‘œì‹œ
  ctx.font = "bold 17px sans-serif";
  ctx.fillStyle = "#ff2";
  ctx.textAlign = "center";
  ctx.fillText("N", centerX, centerY - radius + 19);

  // === ê²½í—˜ì¹˜ êµ¬ìŠ¬ ìœ„ì¹˜ ë…¸ë€ ì ìœ¼ë¡œ ì°ê¸° ===
  orbs.forEach(orb => {
    const dx = orb.x - player.x;
    const dy = orb.y - player.y;
    if (dx * dx + dy * dy < worldView * worldView / 1.8) {
      const dotX = centerX + dx * mapScale;
      const dotY = centerY + dy * mapScale;
      ctx.beginPath();
      ctx.arc(dotX, dotY, 4, 0, Math.PI * 2);
      ctx.fillStyle = "#ffe76a";
      ctx.globalAlpha = 0.9;
      ctx.shadowColor = "#ffe76a";
      ctx.shadowBlur = 6;
      ctx.fill();
      ctx.shadowBlur = 0;
    }
  });

  // === ë‚˜ë¹„ ëª¬ìŠ¤í„°(ì‚´ì•„ìˆëŠ”) ìœ„ì¹˜ ë¹¨ê°„ ì ìœ¼ë¡œ í‘œì‹œ ===
  ctx.globalAlpha = 1.0;
  butterflies.forEach(b => {
    if (b.state === "dead") return; // ì£½ì€ ê±´ í‘œì‹œ ì•ˆ í•¨
    const dx = b.x - player.x;
    const dy = b.y - player.y;
    if (dx * dx + dy * dy < worldView * worldView / 1.8) {
      const dotX = centerX + dx * mapScale;
      const dotY = centerY + dy * mapScale;
      ctx.beginPath();
      ctx.arc(dotX, dotY, 3, 0, Math.PI * 2);
      ctx.fillStyle = "#ff2d2d";
      ctx.globalAlpha = 0.95;
      ctx.shadowColor = "#ff3333";
      ctx.shadowBlur = 6;
      ctx.fill();
      ctx.shadowBlur = 0;
    }
  });

  // === ë‚´ ìœ„ì¹˜ (ì—°ë‘ìƒ‰ ì›) ===
  ctx.beginPath();
  ctx.arc(centerX, centerY, 7.5, 0, Math.PI * 2);
  ctx.fillStyle = "#4bff6b";
  ctx.globalAlpha = 1.0;
  ctx.shadowColor = "#fff";
  ctx.shadowBlur = 6;
  ctx.fill();
  ctx.shadowBlur = 0;

  ctx.restore();
}

    
    // draw() ì œì¼ ë§ˆì§€ë§‰ ë¶€ë¶„
updateKillMsgParticles();
drawKillMsgParticles();
drawKillMsg();


      requestAnimationFrame(draw);
    }

    // ì´ë¯¸ì§€ 3ê°œ ëª¨ë‘ ë¡œë“œ í›„ ë£¨í”„ ì‹œì‘
    let loadedCount = 0;

[grassImg, treeImg, scoutImg, arrowImg].forEach(img => {
  img.onload = () => {
    loadedCount++;
    if (loadedCount === 4) {
      requestOrbs(); // â˜…â˜…â˜… ì¶”ê°€! ìµœì´ˆì— êµ¬ìŠ¬ ìš”ì²­
      draw();
    }
  }
});


function renderRanking() {
  const rankList = document.getElementById('rankList');
  rankList.innerHTML = '';

  // ë ˆë²¨ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  const sorted = Object.values(allPlayers)
    .filter(p => p && p.name)
    .sort((a, b) => (b.level ?? 1) - (a.level ?? 1));

  // ìƒìœ„ 3ëª…ë§Œ ìë¥´ê¸°
  sorted.slice(0, 3).forEach((p, idx) => {
    const div = document.createElement('div');
    div.className = 'rankRow' + (idx === 0 ? ' top1' : idx === 1 ? ' top2' : idx === 2 ? ' top3' : '');
    div.innerHTML = `
      <span class="rankNum">${idx + 1}</span>
      <span class="name">${p.name}</span>
      <span class="level">Lv.${p.level ?? 1}</span>
    `;
    rankList.appendChild(div);
  });
}

// Xì¶• ë°˜ë³µ (ì¢Œìš°)
if (player.x < 0) {
  player.x = MAP_SIZE;
}
if (player.x > MAP_SIZE) {
  player.x = 0;
}

// Yì¶• ë°˜ë³µ (ìƒí•˜)
if (player.y < 0) {
  player.y = MAP_SIZE;
}
if (player.y > MAP_SIZE) {
  player.y = 0;
}




  </script>
</body>
</html>
